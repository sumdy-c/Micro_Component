class MCState{id;value;traceKey;virtualCollection;fcCollection;effectCollection;passport;local;guestState;incorrectStateBindError;_version=0;_identityHash=null;static _objIdMap=new WeakMap;static _nextObjId=1;nameProp;constructor(e,t){t&&(this.local=t);let{value:n,traceKey:i,id:o}=e;this.value=n,this.guestState=!1,this.incorrectStateBindError=!1,this.traceKey=i,this.id=o,this.virtualCollection=new Set,this.fcCollection=new Set,this.effectCollection=new Set,this.nameProp=null,this._identityHash=MCState.computeShallowIdentity(n),this._version=1}setPassport(e){this.passport=e}set(e){if(e===this.value)return;let t=typeof this.value;if((null===this.value||"object"!==t)&&(null===e||"object"!=typeof e));else{let n=!1;if(Array.isArray(this.value)&&Array.isArray(e)){if(this.value.length===e.length){let i=!0;for(let o=0;o<this.value.length;o++)if(this.value[o]!==e[o]){i=!1;break}i&&(n=!0)}if(!n&&e.length>500){let s=MCState.computeShallowIdentity(e);s===this._identityHash&&(n=!0)}}else if(!Array.isArray(this.value)&&!Array.isArray(e)){let r=this.value&&"object"==typeof this.value?Object.keys(this.value):[],l=e&&"object"==typeof e?Object.keys(e):[];if(r.length===l.length){let c=!0;for(let a=0;a<r.length;a++){let f=r[a];if(!Object.prototype.hasOwnProperty.call(e,f)||this.value[f]!==e[f]){c=!1;break}}c&&(n=!0)}if(!n&&r.length>200){let u=MCState.computeShallowIdentity(e);u===this._identityHash&&(n=!0)}}if(n)return}if(!MCState.deepEqual(e,this.value)&&this.passport){this.value=e;let h=_mc_instance_restore_object.instance;h.listPendingRedrawRequests.delete(this.id),h.listPendingRedrawRequests.add(this.id),h._batchUpdateScheduled||(h._batchUpdateScheduled=!0,queueMicrotask(()=>{let e=_mc_instance_restore_object.instance,t=()=>{let n=Array.from(e.listPendingRedrawRequests);if(e.listPendingRedrawRequests.clear(),!n.length){e._batchUpdateScheduled=!1;return}e._batching=!0;for(let i=0;i<n.length;i++){let o=e.getStateID(n[i]);o?.passport&&(i===n.length-1&&(e._batching=!1),o.passport.value=o.value)}if(e._batching=!1,e.listPendingRedrawRequests.size){queueMicrotask(t);return}e._batchUpdateScheduled=!1};t()}))}}get(){return MCState.deepClone(this.value)}initial(){this.passport.value=this.value}static computeShallowIdentity(e){if(null===e)return"null";let t=typeof e;if("object"!==t)return`p:${t}:${String(e)}`;if(e instanceof Date)return`D:${e.getTime()}`;if(e instanceof RegExp)return`R:${e.source}:${e.flags}`;if(Array.isArray(e)){let n=e.length,i=[`A:${n}`],o=Math.min(8,n);for(let s=0;s<o;s++)i.push(MCState._tokenForShallow(e[s]));if(n>16){i.push("..");for(let r=n-8;r<n;r++)i.push(MCState._tokenForShallow(e[r]))}else for(let l=o;l<n;l++)i.push(MCState._tokenForShallow(e[l]));return i.join("|")}if(e instanceof Map){let c=e.size,a=[`M:${c}`],f=0;for(let[u,h]of e)if(a.push(`${MCState._tokenForShallow(u)}=>${MCState._tokenForShallow(h)}`),++f>=8)break;return a.join("|")}if(e instanceof Set){let d=e.size,m=[`S:${d}`],p=0;for(let C of e)if(m.push(MCState._tokenForShallow(C)),++p>=8)break;return m.join("|")}let g=Object.keys(e),y=g.length,M=[`O:${y}`],b=g.slice(0,12);for(let v of b)M.push(`${v}=${MCState._tokenForShallow(e[v])}`);return y>12&&M.push(".."),M.join("|")}static _tokenForShallow(e){if(null===e)return"null";let t=typeof e;return"object"===t?`obj#${MCState._getObjectId(e)}`:`${t}:${String(e)}`}static _getObjectId(e){if(null===e||"object"!=typeof e)return 0;let t=MCState._objIdMap.get(e);return t||(t=MCState._nextObjId++,MCState._objIdMap.set(e,t)),t}static deepEqual(e,t){if(e===t)return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(e instanceof RegExp&&t instanceof RegExp)return e.source===t.source&&e.flags===t.flags;if(e instanceof Map&&t instanceof Map){if(e.size!==t.size)return!1;for(let[n,i]of e)if(!t.has(n)||!MCState.deepEqual(i,t.get(n)))return!1;return!0}if(e instanceof Set&&t instanceof Set){if(e.size!==t.size)return!1;for(let o of e){let s=!1;for(let r of t)if(MCState.deepEqual(o,r)){s=!0;break}if(!s)return!1}return!0}let l=new WeakMap;return function e(t,n){if(t===n)return!0;if("object"!=typeof t||null===t||"object"!=typeof n||null===n)return!1;if(t instanceof Date&&n instanceof Date)return t.getTime()===n.getTime();if(t instanceof RegExp&&n instanceof RegExp)return t.source===n.source&&t.flags===n.flags;if(l.has(t))return l.get(t)===n;l.set(t,n);let i=Array.isArray(t),o=Array.isArray(n);if(i!==o)return!1;if(i&&o){if(t.length!==n.length)return!1;for(let s=0;s<t.length;s++)if(!e(t[s],n[s]))return!1;return!0}let r=Object.keys(t),c=Object.keys(n);if(r.length!==c.length)return!1;for(let a=0;a<r.length;a++){let f=r[a];if(!Object.prototype.hasOwnProperty.call(n,f)||!e(t[f],n[f]))return!1}return!0}(e,t)}static deepClone(e){if("function"==typeof structuredClone)try{return structuredClone(e)}catch(t){}let n=new WeakMap;return function e(t){if(null===t||"object"!=typeof t)return t;if(n.has(t))return n.get(t);if(t instanceof Date){let i=new Date(t.getTime());return n.set(t,i),i}if(t instanceof RegExp){let o=RegExp(t.source,t.flags);return n.set(t,o),o}if(Array.isArray(t)){let s=[];n.set(t,s);for(let r=0;r<t.length;r++)s[r]=e(t[r]);return s}if(t instanceof Map){let l=new Map;for(let[c,a]of(n.set(t,l),t))l.set(e(c),e(a));return l}if(t instanceof Set){let f=new Set;for(let u of(n.set(t,f),t))f.add(e(u));return f}let h={};n.set(t,h);let d=Object.keys(t);for(let m=0;m<d.length;m++){let p=d[m];h[p]=e(t[p])}return h}(e)}}class MCLog{component;constructor(e){if(!e){console.error("Ошибка инициализации логирования для ресурсов MC.");return}this.component=e}error(e,t){let n=`[${this.component.constructor.name}]`;for(let i of(console.groupCollapsed(`%c${n} ${e}`,"color: #ff5959; font-weight: bold;"),t))console.error(i);console.groupEnd()}warn(e,t){let n=`[${this.component.constructor.name}]`;for(let i of(console.groupCollapsed(`%c${n} ${e}`,"color: #ff8500; font-weight: bold;"),t))console.warn(i);console.groupEnd()}}class MCEngine{mc;competitionСounter;constructor(e){this.mc=e,this.diff=new MCDiff(this.mc),this.competitionСounter=!1,this.count=0}handlerRender(e,t,n,i){let o={};n||(n="obj");let s=new Proxy(e,{get:(i,s)=>"object"!=typeof e[s]?e[s]:(void 0===o[s]&&(o[s]=this.handlerRender(e[s],t,`${n}.${s}`)),Reflect.get(...arguments)),set:(e,n,o)=>{e[n]=o;let s=this.mc;return("MC"!==s.constructor.name&&(s=s.mc),s.getCurrentRenderingInstance())?(s.listPendingRedrawRequests.add(i.id),!0):(s._batching||t(i,this.mc,this),!0)}});return s}jqToHtml(e){if(!e)return null;let[t]=e;return t||null}diffing(e){let t=e.draw(this.getArrayValuesStates(e),e.props),n=this.jqToHtml(t)??new MC_Element().createEmptyElement();n.instanceMC=e.id,n.instanceMCtype="fn",e.HTML=this.diff.start(e.HTML,n)}formationStates(e){let t={};for(let n of e.normalized.states)!n.incorrectStateBindError&&(n.local?t[n.nameProp]=[n.get(),e=>n.set(e),n,]:t[n.nameProp]=[n.get(),e=>n.set(e),n,]);return t}diffingComponent(e){"MC"!==this.mc.constructor.name&&(this.mc=this.mc.mc),this.mc.setCurrentRenderingInstance(e.key);let t=this.formationStates(e),n=e.draw.call(e.component,t,e.normalized.props,e);this.mc.resetCurrentRenderingInstance();let i=this.jqToHtml(n)??new MC_Element().createEmptyElement();i.instanceMC=e.id,i.instanceMCtype="mc_component",e.HTML=this.diff.start(e.HTML,i),this.mc.listPendingRedrawRequests.size&&(this.mc.listPendingRedrawRequests.forEach(e=>{let t=this.mc.getStateID(e);t.passport&&(t.passport.value=t.value)}),this.mc.listPendingRedrawRequests.clear())}rerender(e,t="fn"){let n=null;if("mc_component"===t){"MC"!==this.mc.constructor.name&&(this.mc=this.mc.mc),this.mc.setCurrentRenderingInstance(e.component.uniquekey);let i=this.formationStates(e),o=e.draw.call(e.component,i,e.normalized.props,e);this.mc.deleteKeyCurrentRenderingInstance(e.component.uniquekey),(n=this.jqToHtml(o)??new MC_Element().createEmptyElement()).instanceMC=e.id,n.instanceMCtype="mc_component",e.HTML=n}else{let s=e.draw(this.getArrayValuesStates(e),e.props);(n=this.jqToHtml(s)??new MC_Element().createEmptyElement()).instanceMC=e.id,n.instanceMCtype="fn",e.HTML=n}return e.HTML}render(e,t,n){let i=Boolean(e.fcCollection.size),o=Boolean(e.virtualCollection.size),s=Boolean(e.effectCollection.size);i&&n.renderFunctionContainer(e,t),o&&n.renderComponentWork(e,t),s&&n.runEffectWork(e,t),"MC"!==t.constructor.name&&(t=t.mc),t.scheduleCleanDeadVDOM()}controlledRender(e,t="mc_component"){if("mc_component"===t){this.diffingComponent(e);return}this.diffing(e)}getArrayValuesStates(e){return Array.from(e.states.values())}renderFunctionContainer(e,t){"MC"!==t.constructor.name&&(t=t.mc),e.fcCollection.forEach(n=>{let i=t.fcCollection.get(n.effectKey),o=i.states.get(e.id);o!==e.value&&(i.states.set(e.id,e.value),this.diffing(i))})}renderComponentWork(e,t){"MC"!==t.constructor.name&&(t=t.mc),e.virtualCollection.forEach(n=>{let i=t.componentCollection.get(n.effectKey),o=i.states.get(e.id);o!==e.value&&(i.states.set(e.id,e.value),this.diffingComponent(i))})}runEffectWork(e,t){"MC"!==t.constructor.name&&(t=t.mc),e.effectCollection.forEach(n=>{let i=t.effectCollection.get(n.effectKey),o=i.states.get(e.id);if(o!==e.value){i.states.set(e.id,e.value);let s=i.run(this.getArrayValuesStates(i),i.options);s&&(i.unmountCaller=s)}})}registrController(e){let t={value:e.id},n=this.handlerRender(t,this.render,"",e);e.setPassport(n)}}class MC_Element{constructor(e){return this.getComponent(e)}setAttributes(e){e.HTML.setAttribute("style","height: 0; width: 0; display: none;")}createEmptyElement(){let e=document.createElement("mc");return e.setAttribute("style","height: 0; width: 0; display: none;"),e}getComponent(e){return e}}class ServiceDiff{serviceArrtibute;constructor(){this.serviceArrtibute=new Set,this.serviceArrtibute.add("mc_rnd_model_controlled")}checkServiceAttribute(e){if(this.serviceArrtibute.has(e))return!0}}class EventDiff{diffEvents(e,t,n){let i=e.__mcEvents||{},o=t.__mcEvents||{},s={},r=[];for(let l in o)s[l]=o[l];for(let c in i)r.push(c);return{set:s,remove:r,ctx:n}}applyEvents(e,t){if(e){for(let[n,i]of(t.__mcBound=t.__mcBound||{},(e.remove||[]).forEach(e=>{t.__mcBound[e]&&(t.__mcBound[e].forEach(n=>{$(t).unbind(e)}),delete t.__mcBound[e])}),Object.entries(e.set||{})))if(i&&i.length)for(let o of i)$(t).on(n,o),t.__mcBound[n]=t.__mcBound[n]||[],t.__mcBound[n].push(o)}}}class AttrDiff{serviceDiff;mc;constructor(e,t){this.serviceDiff=e,this.mc=t}diffAttributes(e,t,n){let i=e.attributes?Array.from(e.attributes):[],o=t.attributes?Array.from(t.attributes):[],s={},r=[];for(let l of o)e.getAttribute(l.name)!==l.value&&(s[l.name]=l.value);for(let c of i)t.hasAttribute(c.name)||r.push(c.name);if(1===e.nodeType&&1===t.nodeType){let a=(t.tagName||"").toLowerCase();if("input"===a||"textarea"===a||"select"===a){let f=null!=e.value?String(e.value):e.getAttribute("value"),u=null!=t.value?String(t.value):t.getAttribute("value");f!==u&&(s.value=null==u?"":u)}if("input"===a&&("checkbox"===t.type||"radio"===t.type)){let h=!!e.checked,d=!!t.checked;h!==d&&(d?s.checked="checked":r.push("checked"))}}return{set:s,remove:r,ctx:n}}applyAttributes(e,t){if(e){for(let[n,i]of Object.entries(e.set||{})){if("value"===n){try{"value"in t&&(t.value=i)}catch(o){}if(t.setAttribute("value",i),t.tagName&&"select"===t.tagName.toLowerCase()){let s=String(i);for(let r of t.options||[]){let l=r.value===s;r.selected=l,l?r.setAttribute("selected","selected"):r.removeAttribute("selected")}}continue}if("checked"===n){"checked"in t&&(t.checked=!0),t.setAttribute("checked","checked");continue}t.setAttribute(n,i)}for(let c of e.remove||[]){if("checked"===c){"checked"in t&&(t.checked=!1),t.removeAttribute("checked");continue}if("value"===c){if("value"in t&&(t.value=""),t.removeAttribute("value"),t.tagName&&"select"===t.tagName.toLowerCase())for(let a of t.options||[])a.selected=!1,a.removeAttribute("selected");continue}t.removeAttribute(c)}}}}class StyleDiff{diffStyles(e,t,n){let i=e.getAttribute&&e.getAttribute("style")||"",o=t.getAttribute&&t.getAttribute("style")||"";return i!==o?{set:o,ctx:n}:{ctx:n}}applyStyles(e,t){e&&"set"in e&&t.setAttribute("style",e.set)}}class ClassDiff{diffClasses(e,t,n){let i=e.getAttribute&&e.getAttribute("class")||"",o=t.getAttribute&&t.getAttribute("class")||"";return i!==o?{set:o,ctx:n}:{ctx:n}}applyClasses(e,t){e&&"set"in e&&t.setAttribute("class",e.set)}}class MasterDiff{attrDiff;styleDiff;classDiff;serviceDiff;mc;constructor(e,t,n,i,o){this.attrDiff=e,this.styleDiff=t,this.classDiff=n,this.eventDiff=i,this.mc=o}cleanupVDOM(e,t){if("MC"!==this.mc.constructor.name&&(this.mc=this.mc.mc),"fn"===e.instanceMCtype){let n=e.instanceMC,i=this.mc.fcCollection.get(this.mc.fcIdsCollection.get(n));i&&(i.HTML=null),"fn"===t.instanceMCtype&&t.instanceMC&&(e.instanceMC=t.instanceMC),t.instanceMC||(e.instanceMC=void 0);return}if("mc_component"===e.instanceMCtype){let o=e.instanceMC,s=this.mc.componentCollection.get(this.mc.componentIdsCollection.get(o));s&&(s.HTML=null),"mc_component"===t.instanceMCtype&&t.instanceMC&&(e.instanceMC=t.instanceMC),t.instanceMC||(e.instanceMC=void 0)}}diffNode(e,t,n){let i=Object.assign({level:0,path:""},n);if(!e&&t)return{type:"ADD",node:t,ctx:i};if(e&&!t)return{type:"REMOVE",ctx:i};if(!e&&!t)return{type:"NONE",ctx:i};if(e.instanceMC&&t.instanceMC&&e.instanceMC!==t.instanceMC&&this.cleanupVDOM(e,t),e.instanceMC&&!t.instanceMC&&this.cleanupVDOM(e,t),!e.instanceMC&&t.instanceMC&&(e.instanceMC=t.instanceMC,e.instanceMCtype=t.instanceMCtype),e.nodeType!==t.nodeType)return{type:"REPLACE",node:t,ctx:i};if(e.nodeType===Node.TEXT_NODE)return e.textContent!==t.textContent?{type:"TEXT",text:t.textContent,ctx:i}:{type:"NONE",ctx:i};if(e.nodeType===Node.COMMENT_NODE)return e.textContent!==t.textContent?{type:"COMMENT",text:t.textContent,ctx:i}:{type:"NONE",ctx:i};if(e.nodeType===Node.DOCUMENT_FRAGMENT_NODE||e.nodeType===Node.DOCUMENT_NODE||e.nodeType===Node.DOCUMENT_TYPE_NODE)return this.diffChildren(e,t,i);if(e.nodeType===Node.ELEMENT_NODE){if(e.nodeName!==t.nodeName)return{type:"REPLACE",node:t,ctx:i};let o=this.attrDiff.diffAttributes(e,t,i),s=this.styleDiff.diffStyles(e,t,i),r=this.classDiff.diffClasses(e,t,i),l=this.eventDiff.diffEvents(e,t,i);e.instanceMC&&t.instanceMC&&e.instanceMC!==t.instanceMC&&(e.instanceMC=t.instanceMC);let c=this.diffChildren(e,t,i);return{type:"UPDATE",attrPatch:o,stylePatch:s,classPatch:r,eventPatch:l,childrenPatch:c,ctx:i}}return{type:"REPLACE",node:t,ctx:i}}diffChildren(e,t,n){let i=Object.assign({},n,{level:(n.level||0)+1}),o=Array.from(e.childNodes),s=Array.from(t.childNodes),r=Math.max(o.length,s.length),l=[];for(let c=0;c<r;c++){let a=i.path+"/"+c;l.push(this.diffNode(o[c],s[c],{...i,path:a}))}return{type:"CHILDREN",patches:l,ctx:i}}}class PatchMaster{attrDiff;styleDiff;classDiff;serviceDiff;eventDiff;mc;constructor(e,t,n,i,o){this.attrDiff=e,this.styleDiff=t,this.classDiff=n,this.eventDiff=i,this.mc=o}reconnectingVDOM(e){let t=e=>{if(e.instanceMC){if("fn"===e.instanceMCtype){let t=e.instanceMC,n=this.mc.fcCollection.get(this.mc.fcIdsCollection.get(t));n&&(n.HTML=e)}if("mc_component"===e.instanceMCtype){let i=e.instanceMC;"MC"!==this.mc.constructor.name&&(this.mc=this.mc.mc);let o=this.mc.componentCollection.get(this.mc.componentIdsCollection.get(i));o&&(o.HTML=e,o.HTML.isConnected&&!o._mountedCalled&&(o.mounted(),o._mountedCalled=!0))}}};1===e.nodeType&&e.instanceMC&&t(e);let n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>e.instanceMC?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP},!1),i=n.nextNode();for(;i;)t(i),i=n.nextNode()}applyPatch(e,t,n){if(!e)return t;let i=Object.assign({level:0,path:""},n);switch(e.type){case"ADD":return t&&t.parentNode&&t.parentNode.appendChild(e.node),e.node;case"REMOVE":return t&&t.parentNode&&t.parentNode.removeChild(t),null;case"REPLACE":return t&&t.parentNode&&t.parentNode.replaceChild(e.node,t),e.node;case"TEXT":if(t&&t.nodeType===Node.TEXT_NODE)return t.textContent=e.text,t;if(t&&t.parentNode){let o=document.createTextNode(e.text);return t.parentNode.replaceChild(o,e.node),o}return document.createTextNode(e.text);case"COMMENT":if(t&&t.nodeType===Node.COMMENT_NODE)return t.nodeValue=e.text,t;if(t&&t.parentNode){let s=document.createComment(e.text);return t.parentNode.replaceChild(s,t),s}return document.createComment(e.text);case"UPDATE":return this.attrDiff.applyAttributes(e.attrPatch,t),this.styleDiff.applyStyles(e.stylePatch,t),this.classDiff.applyClasses(e.classPatch,t),this.eventDiff.applyEvents(e.eventPatch,t),this.applyPatch(e.childrenPatch,t,i),t;case"CHILDREN":return this._applyChildren(e.patches,t,i),t;default:return t}}_applyChildren(e,t,n){for(let i=0;i<e.length;i++){let o=e[i],s=t.childNodes[i];if(!s&&o&&"ADD"===o.type){t.appendChild(o.node);continue}if(s&&o&&"REMOVE"===o.type){--i,t.removeChild(s);continue}(s||!o)&&s&&o&&this.applyPatch(o,s,n)}for(let r=t.childNodes.length;r<e.length;r++){let l=e[r];l&&"ADD"===l.type&&t.appendChild(l.node)}}}class MCDiff{master;patch;constructor(e){let t=new ServiceDiff,n=new AttrDiff(t,e),i=new StyleDiff(t),o=new ClassDiff(t),s=new EventDiff;this.master=new MasterDiff(n,i,o,s,e),this.patch=new PatchMaster(n,i,o,s,e)}start(e,t){let n="MC"===this.patch.mc.constructor.name?this.patch.mc:this.patch.mc.mc;try{n._domObserverSuppress++;let i=this.master.diffNode(e,t,{level:0,path:""}),o=this.patch.applyPatch(i,e,{level:0,path:""});return o&&this.patch.reconnectingVDOM(o),o}finally{n._domObserverSuppress--}}}class MC_Component{mc;constructor(e){this.mc=e}createNewInstance(e){let t=new e.component(e.props,e.context,e.uniquekey);return t.mc=this.mc,t}createSignatureComponent(e,t){let n=this.createNewInstance(e);n.uniquekey=e.uniquekey,n.parentKey=this.mc.getCurrentRenderingInstance();let i={draw:n.render,mounted:n.mounted?n.mounted:()=>{},_mountedCalled:!1,unmounted:n.unmounted?n.unmounted:()=>{},key:e.key,id:t,states:new Map,context:e.context,HTML:new MC_Element().createEmptyElement(),normalized:e,component:n};for(let o in n)if(n[o]instanceof MCState){let s=n[o];s.local&&!s.traceKey&&(s.traceKey=`lcl_state_${e.key}`,s.nameProp=o,e.states.push(n[o])),n.componentCollection.set(e.key,i),n.componentIdsCollection.set(t,e.key)}return this.mc.componentCollection.set(e.key,i),this.mc.componentIdsCollection.set(t,e.key),i}register(e,t){let n=this.createSignatureComponent(e,t);if(e.states.length)for(let i of e.states)this.mc.isStateLike(i)?(i.virtualCollection.add({effectKey:n.key}),n.states.set(i.id,i.value)):this.mc.log.error("Неверный стейт",["Переданная сигнатура состояния неверна. Проверьте данные которые вы передали в зависимости",]);return this.start(n),n.HTML.instanceMC=n.id,n.HTML.instanceMCtype="mc_component",n.HTML}start(e){if(this.mc.getCurrentRenderingInstance()){e.HTML=this.mc.engine.rerender(e,"mc_component");return}this.mc.engine.controlledRender(e,"mc_component")}}class MCcontext{id;key;virtualCollection;constructor(e){let{id:t,key:n}=e;this.id=t,this.key=n??null,this.virtualCollection=new Set}create(e,t,n){let i={component:e,parent_id:this.id,key:t,identifier:n};return this.virtualCollection.add(i),[{context:this.id,id_element:t},i]}}const _mc_instance_restore_object={instance:null};class MC{original$;mc;stateList;mc_state_global;mc_context_global;_cleaningScheduled;fcCollection;fcIdsCollection;componentCollection;componentIdsCollection;componentHandler;currentRenderingInstance;listPendingRedrawRequests;constructor(){this._pendingMountRoots=new Set,this._mountObserver=null,this.log=new MCLog(this),this.engine=new MCEngine(this),this.componentHandler=new MC_Component(this),this.stateList=new Map,this.fcCollection=new Map,this.fcIdsCollection=new Map,this.effectCollection=new Map,this.effectIdsCollection=new Map,this.componentCollection=new Map,this.componentIdsCollection=new Map,this.currentRenderingInstance=new Set,this.COUNTER_CLEAR=150,this.checkCountClearedFunctionContainers=this.COUNTER_CLEAR,this.mc_state_global=new Set,this.mc_context_global=new Set,this._cleaningScheduled=!1,this.listPendingRedrawRequests=new Set,this._batching=!1,this._domObserver=null,this._domObserverSuppress=0,this._obsRemovedRoots=new Set,this._obsAddedRoots=new Set,this._obsFlushScheduled=!1,window.$?this.original$=window.$:this.log.error("JQuery функция не была обнаружена!",["Для работы MC данного выпуска необходимо подлючение JQuery версии 1.5 или выше","Проверьте подключение библиотеки, либо используйте init после её определения",])}static init(){if(this.mc){this.mc.log.warn("На данной странице уже инициализирован Micro Component",["Вы пытаетесь инициализировать MC на странице больше одного раза.","Такое действие не имеет цели для обработчиков МС",]),this.mc.use();return}this.mc=new MC,_mc_instance_restore_object.instance=this.mc,window.$.MC=this.mc.use.bind(this),window.$.MC.memo=this.mc.useMemo.bind(this),window.$.MC.effect=this.mc.useEffect.bind(this),window.iMC=this.mc,window.iMC.mc=this;let e=window.$.fn.on;window.$.fn.on=function(t,n,i,o){let s;if("function"==typeof n)s=n;else{if("function"!=typeof o)return e.apply(this,arguments);s=o}let r=this[0];return r&&(r.__mcBound=r.__mcBound||{},r.__mcEvents=r.__mcEvents||{},r.__mcBound[t]||(r.__mcBound[t]=[]),r.__mcEvents[t]||(r.__mcEvents[t]=[]),r.__mcBound[t].push(s),r.__mcEvents[t].push(s)),e.apply(this,arguments)},this.mc._enableDomObserver()}static enableFragmentShortSyntax(){if("undefined"==typeof window||!window.$||!window.$.fn||!window.$.fn.init)throw Error("jQuery не найден в window.$ — нельзя включить fragment short-syntax");if(window.$.mcInitPatched)return;let e=window.$,t=e.fn.init;e.mcOriginalInit||(e.mcOriginalInit=t),e.fn.init=function(e,n,i){if("string"==typeof e&&"</>"===e){let o=t.call(this),s=document.createDocumentFragment();return o[0]=s,o.length=1,o._isDocumentFragment=!0,o}return t.call(this,e,n,i)},e.fn.init.prototype=t.prototype,e.mcInitPatched=!0,e.mcLogPatched||(e.mcLogPatched=!0)}static disableFragmentShortSyntax(){if("undefined"==typeof window||!window.$||!window.$.fn)return;let e=window.$;e.mcInitPatched&&(e.mcOriginalInit&&(e.fn.init=e.mcOriginalInit,e.fn.init.prototype=e.mcOriginalInit.prototype||e.fn,delete e.mcOriginalInit),delete e.mcInitPatched,delete e.mcLogPatched)}static uState(e,t,n){if(!t){this.mc.log.error("Ошибка генерации ключа",["Не удалось получить ключ для состояния",]);return}let[i]=this.mc.getState(t);return i?(n&&i.set(e),i):this.mc.createState(e,t)}static uContext(e){if(!e){this.mc.log.error("Ошибка генерации ключа",["Не удалось получить ключ для состояния",]);return}let t=this.mc.getContext(e);return t||this.mc.createContext(e)}static getState(e){let t=[];return e?(this.mc.mc_state_global.forEach(n=>{n.traceKey===e&&t.push(n)}),t):(this.mc.mc_state_global.forEach(e=>{t.push(e)}),t)}static getContext(e){let t;return this.mc.mc_context_global.forEach(n=>{n.key===e&&(t=n)}),t}scheduleCleanDeadVDOM(){if(this._cleaningScheduled||this._domObserver)return;this._cleaningScheduled=!0;let e=async()=>{try{await this.checkAllDeadsFunctionsContainers(),await this.checkAllDeadsClassComponentsContainers()}finally{this._cleaningScheduled=!1}};"requestIdleCallback"in window?requestIdleCallback(e,{timeout:500}):setTimeout(e,200)}_trackMountRoot(e){if(e&&1===e.nodeType){if(e.isConnected){this.engine.diff.patch.reconnectingVDOM(e);return}this._pendingMountRoots.add(e),this._ensureMountObserver()}}_ensureMountObserver(){this._mountObserver||(this._mountObserver=new MutationObserver(()=>{for(let e of Array.from(this._pendingMountRoots))e.isConnected&&(this.engine.diff.patch.reconnectingVDOM(e),this._pendingMountRoots.delete(e));0===this._pendingMountRoots.size&&(this._mountObserver.disconnect(),this._mountObserver=null)}),this._mountObserver.observe(document.documentElement,{childList:!0,subtree:!0}))}_cleanupFunctionContainerByKey(e){let t=this.fcCollection.get(e);if(t&&(!t.HTML||!t.HTML.isConnected)){for(let[n]of(this.fcIdsCollection.delete(t.id),t.states)){let i=this.getStateID(n);if(i){for(let o of i.fcCollection)if(o.effectKey===e){i.fcCollection.delete(o);break}}}this.fcCollection.delete(e)}}_cleanupComponentByKey(e){let t=this.componentCollection.get(e);if(!t||t.HTML&&t.HTML.isConnected)return;try{t.unmounted?.()}catch(n){}for(let[i]of(this.componentIdsCollection.delete(t.id),t.states)){let o=this.getStateID(i);if(o){for(let s of o.virtualCollection)if(s.effectKey===e){o.virtualCollection.delete(s);break}o.local&&0===o.virtualCollection.size&&this.mc_state_global.delete(o)}}let r=[];for(let[l,c]of this.effectCollection)if(c.parent===t.key){try{c.unmountCaller()}catch(a){}for(let[f]of(r.push(l),c.states)){let u=this.getStateID(f);if(u)for(let h of u.effectCollection)h.effectKey===l&&u.effectCollection.delete(h)}}for(let d of r)this.effectCollection.delete(d);this.componentCollection.delete(e)}_enableDomObserver(){this._domObserver||(this._domObserver=new MutationObserver(e=>{if(!(this._domObserverSuppress>0)){for(let t of e){for(let n of t.addedNodes||[])n&&1===n.nodeType&&this._obsAddedRoots.add(n);for(let i of t.removedNodes||[])i&&1===i.nodeType&&this._obsRemovedRoots.add(i)}!this._obsFlushScheduled&&(this._obsAddedRoots.size||this._obsRemovedRoots.size)&&(this._obsFlushScheduled=!0,queueMicrotask(()=>{try{this._flushDomObserverQueues()}finally{this._obsFlushScheduled=!1}}))}}),this._domObserver.observe(document.documentElement,{childList:!0,subtree:!0}))}_flushDomObserverQueues(){if(this._obsAddedRoots.size){let e=Array.from(this._obsAddedRoots);for(let t of(this._obsAddedRoots.clear(),e)){if(!t||!t.isConnected)continue;if(t.instanceMC){this.engine.diff.patch.reconnectingVDOM(t);continue}let n=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>e.instanceMC?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP});n.nextNode()&&this.engine.diff.patch.reconnectingVDOM(t)}}if(this._obsRemovedRoots.size){let i=Array.from(this._obsRemovedRoots);for(let o of(this._obsRemovedRoots.clear(),i))o&&!o.isConnected&&this._cleanupRemovedSubtree(o)}}_cleanupRemovedSubtree(e){let t=new Set,n=new Set,i=e=>{if(!e||!e.instanceMC)return;let i=e.instanceMC;if("fn"===e.instanceMCtype){let o=this.fcIdsCollection.get(i);o&&t.add(o)}else if("mc_component"===e.instanceMCtype){let s=this.componentIdsCollection.get(i);s&&n.add(s)}};1===e.nodeType&&i(e);let o=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>e.instanceMC?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}),s=o.nextNode();for(;s;)i(s),s=o.nextNode();for(let r of t)this._cleanupFunctionContainerByKey(r);for(let l of n)this._cleanupComponentByKey(l)}setCurrentRenderingInstance(e){this.currentRenderingInstance.add(e)}getCurrentRenderingInstance(){let e=this;return"MC"!==e.constructor.name&&(e=this.mc),Array.from(e.currentRenderingInstance).join("_")}resetCurrentRenderingInstance(){let e=this;"MC"!==e.constructor.name&&(e=this.mc),e.currentRenderingInstance.clear()}deleteKeyCurrentRenderingInstance(e){let t=this;"MC"!==t.constructor.name&&(t=this.mc),t.currentRenderingInstance.delete(e)}state(e){return this.createLocallyState(e,this)}uuidv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}getContext(e){let t;return this.mc_context_global.forEach(n=>{n.key===e&&(t=n)}),t}getState(e){let t=[];return e?(this.mc_state_global.forEach(n=>{n.traceKey===e&&t.push(n)}),t):(this.mc_state_global.forEach(e=>{t.push(e)}),t)}getStateID(e){let t=null;return this.mc_state_global.forEach(n=>{n.id===e&&(t=n)}),t}createState(e,t){let n={value:e,traceKey:t,id:this.uuidv4()},i=new MCState(n);return i.nameProp=t,this.engine.registrController(i),this.mc_state_global.add(i),i}createContext(e){let t={id:this.uuidv4(),key:e},n=new MCcontext(t);return this.mc_context_global.add(n),n}createLocallyState(e,t){let n={value:e,id:this.uuidv4(),localKey:null},i=new MCState(n,t);return this.engine.registrController(i),_mc_instance_restore_object.instance.mc_state_global.add(i),i}checkTypeEntity(e){return e.prototype instanceof MC?"mc_component":"Function"===e.constructor.name?"function":(this.log.error("Ошибка определения компонента",["Переданные параметры для функции определения не смогли получить сигнатуру компонента","Проверьте правильность создания своих ресурсов",]),"error")}processFunction(e){let{component:t,instruction:n,key:i,props:o,states:s}=this.normilizeArgs(e);if("mc_inst_effect"===n){let r=this.getEffectVirtual(t,i);if(r){r.parent&&(r.run=t);return}return this.createEffect(t,s,i),null}let l=this.getFunctionContainerVirtual(t,i);return l&&l.HTML.isConnected?(l.props=o,this.workFunctionContainer(l,"mc_inst_memo"===n)):this.createFunctionContainer(t,o,s,i)}simpleHash(e){let t=5381;for(let n=0;n<e.length;n++)t=(t<<5)+t+e.charCodeAt(n);return(t>>>0).toString(16)}generateComponentKey(e,t){let n=e.toString().trim(),i=this.simpleHash(n);return i+`${t}`}createSignatureFunctionContainer(e,t,n,i){let o=this.generateComponentKey(e,i),s={draw:e,props:t,key:o,id:n,states:new Map,HTML:new MC_Element().createEmptyElement()};return this.fcCollection.set(o,s),this.fcIdsCollection.set(n,o),s}createFunctionContainer(e,t,n,i=""){let o=this.uuidv4(),s=this.createSignatureFunctionContainer(e,t,o,i);return n&&n.map(e=>{this.isStateLike(e)?(e.fcCollection.add({effectKey:s.key}),s.states.set(e.id,e.value)):this.log.error("Неверный стейт",["Переданная сигнатура состояния неверна. Проверьте данные которые вы передали в зависимости",])}),n||n.length||this.log.error("Ошибка чтения массива состояний",[`Структура функционального контейнера:`,`${s.draw}`,`- требует наличия массива зависимостей!`,"Если вам не нужны зависимости в данном компоненте, скорее всего вы нецелесообразно используете функциональные контейнеры.",]),s.HTML=this.engine.rerender(s),s.HTML.instanceMC=s.id,s.HTML.instanceMCtype="fn",s.HTML}workFunctionContainer(e,t){return e?t?e.HTML:this.engine.rerender(e):null}getFunctionContainerVirtual(e,t=""){let n=this.generateComponentKey(e,t),i=this.fcCollection.get(n);return!!i&&i}async checkAllDeadsFunctionsContainers(e=100){let t=[];for(let[n,i]of this.fcCollection)i.HTML&&i.HTML.isConnected||t.push(n);for(let o=0;o<t.length;o+=e){let s=t.slice(o,o+e);for(let r of s){let l=this.fcCollection.get(r);if(l){for(let[c]of(this.fcIdsCollection.delete(l.id),l.states)){let a=this.getStateID(c);if(a){for(let f of a.fcCollection)if(f.effectKey===r){a.fcCollection.delete(f);break}}}this.fcCollection.delete(r)}}await new Promise(e=>setTimeout(e,0))}}async checkAllDeadsClassComponentsContainers(e=100){let t=[];for(let[n,i]of this.componentCollection)i.HTML&&i.HTML?.isConnected||t.push(n);for(let o=0;o<t.length;o+=e){let s=t.slice(o,o+e);for(let r of s){let l=this.componentCollection.get(r);if(!l)continue;for(let[c]of(this.componentIdsCollection.delete(l.id),l.states)){let a=this.getStateID(c);if(a){for(let f of a.virtualCollection)if(f.effectKey===r){a.virtualCollection.delete(f),a.local&&!a.virtualCollection.length&&this.mc_state_global.delete(a);break}}}let u=[];for(let[h,d]of this.effectCollection)if(d.parent===l.key)for(let[m]of(d.unmountCaller(),u.push(h),d.states)){let p=this.getStateID(m);if(p)for(let C of p.effectCollection)C.effectKey===h&&p.effectCollection.delete(C)}for(let g of u)this.effectCollection.delete(g);this.componentCollection.delete(r)}await new Promise(e=>setTimeout(e,0))}}createSignatureEffect(e,t,n){let i=this.getCurrentRenderingInstance(),o=i?`${this.generateComponentKey(e,n)}__${i}`:this.generateComponentKey(e,n),s={run:e,key:o,id:t,states:new Map,parent:i||null,unmountCaller(){}};return this.effectCollection.set(o,s),this.effectIdsCollection.set(t,o),s}createEffect(e,t,n=""){let i=this.uuidv4(),o=this.createSignatureEffect(e,i,n);if(t&&t.map(e=>{this.isStateLike(e)?(e.effectCollection.add({effectKey:o.key}),o.states.set(e.id,e.value)):this.log.error("Неверный стейт",["Переданная сигнатура состояния неверна. Проверьте данные которые вы передали в зависимости",])}),!t.length){let s=o.run(o.states.values());s&&(o.unmountCaller=s)}}getEffectVirtual(e,t=""){let n=this.generateComponentKey(e,t),i=this.getCurrentRenderingInstance(),o=null;return(o=this.effectCollection.get(n))||(o=this.effectCollection.get(`${n}__${i}`)),!!o&&o}hashString(e){let t=5381;for(let n=0;n<e.length;n++)t=33*t^e.charCodeAt(n);return(t>>>0).toString(36)}serializeForHash(e){if(null==e)return"null";if("string"==typeof e)return`"${e}"`;if("number"==typeof e||"boolean"==typeof e)return String(e);if(Array.isArray(e))return"["+e.map(e=>this.serializeForHash(e)).join(",")+"]";if("object"==typeof e){let t=Object.keys(e).sort();return"{"+t.map(t=>`"${t}":${this.serializeForHash(e[t])}`).join(",")+"}"}return String(e)}generateKeyFromNormalized(e){let t=[];e.component&&t.push(e.component.name||e.component.toString());let n=e=>{let t=new WeakSet,n=e=>{if(null===e)return"null";if(void 0===e)return"undefined";let o=typeof e;if("string"===o)return"string";if("number"===o)return Number.isNaN(e)?"nan":"number";if("boolean"===o)return"boolean";if("function"===o)return"function";if("symbol"===o)return"symbol";if("bigint"===o)return"bigint";if(e instanceof Date)return"Date";if(e instanceof RegExp)return"RegExp";if(e instanceof Map){let s=[],r=[];for(let[l,c]of e.entries())s.push(n(l)),r.push(n(c));return`Map<${i(s).join(",")}|${i(r).join(",")}>`}if(e instanceof Set){let a=[];for(let f of e.values())a.push(n(f));return`Set<${i(a).join(",")}>`}if(Array.isArray(e)){if(t.has(e))return"Array<...>";t.add(e);let u=e.map(n);return`Array<${i(u).join(",")}>`}if("object"===o){if(t.has(e))return"Object<...>";t.add(e);let h=Object.keys(e).sort(),d=h.map(t=>`${t}:${n(e[t])}`);return`{${d.join(",")}}`}return o},i=e=>Array.from(new Set(e)).sort();return n(e)};return e.props&&Object.keys(e.props).length>0&&t.push(n(e.props)),e.states&&e.states.length>0&&t.push("["+e.states.map(e=>n(e&&e.value)).join("|")+"]"),e.context&&t.push(n(e.context)),this.hashString(t.join("|"))}isStateLike(e){return!!e&&(e instanceof MCState||"function"==typeof e.get&&"function"==typeof e.set)}normilizeArgs(e){let t={component:null,props:{},states:[],key:void 0,context:null,instruction:null};for(let n of e){if(n&&n.prototype instanceof MC||n&&"Function"===n.constructor.name){t.component=n;continue}if(this.isStateLike(n)){if(n.local&&!Array.from(e).includes("mc_inst_effect")){n.incorrectStateBindError=!0,this.log.error("Неправильное назначение",["Локальное состояние компонента не может быть привязано к дочерним компонентам.\n Привязка приведёт к избыточным ререндерингам и потенциальным непредсказуемым побочным эффектам.\n Используйте пропсы или контекстное/глобальное состояние для передачи данных вниз по дереву компонентов.",`traceKey:: ${n.traceKey}`,]);continue}t.states.push(n);continue}if(Array.isArray(n)&&n.every(e=>this.isStateLike(e))){let i=!1;if(n.forEach(t=>{t.local&&!Array.from(e).includes("mc_inst_effect")&&(i=!0,t.incorrectStateBindError=!0,this.log.error("Неправильное назначение",["Локальное состояние компонента не может быть привязано к дочерним компонентам.\n Привязка приведёт к избыточным ререндерингам и потенциальным непредсказуемым побочным эффектам.\n Используйте пропсы или контекстное/глобальное состояние для передачи данных вниз по дереву компонентов.",`traceKey:: ${t.traceKey}`,]))}),i)continue;t.states.push(...n);continue}if("mc_inst_effect"===n||"mc_inst_memo"===n){t.instruction=n;continue}if("string"==typeof n||"number"==typeof n){t.key=n;continue}if(n instanceof MCcontext){t.context=n;continue}if(null!=n&&"object"==typeof n){t.props=Object.assign({},n);continue}null!=n&&(t.props=n)}return t}processComponent(e){let t=this.normilizeArgs(e);t.uniquekey=t.key?t.key:this.generateKeyFromNormalized(t),t.key=t.uniquekey;let n=this.getCurrentRenderingInstance(),i=n?`${n}_${t.key}`:t.key;if(t.key=i,this.componentCollection.has(t.key)){let o=this.componentCollection.get(t.key);return o.normalized.props=t.props,this.engine.rerender(o,"mc_component")}let s=this.uuidv4();return this.componentHandler.register(t,s)}use(){let[e]=arguments,t=this.mc.checkTypeEntity(e);switch(t){case"function":return this.mc.processFunction(arguments);case"mc_component":return this.mc.processComponent(arguments);default:return null}}useMemo(){return 2===arguments.length?this.mc.use.call(this,...arguments,"","mc_inst_memo"):this.mc.use.call(this,...arguments,"mc_inst_memo")}useEffect(){return 2===arguments.length?this.mc.use.call(this,...arguments,"","mc_inst_effect"):this.mc.use.call(this,...arguments,"mc_inst_effect")}}