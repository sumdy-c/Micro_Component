class MCState{id;value;traceKey;virtualCollection;fcCollection;effectCollection;passport;local;guestState;incorrectStateBindError;_version=0;_identityHash=null;static _objIdMap=new WeakMap;static _nextObjId=1;nameProp;constructor(t,e){e&&(this.local=e);const{value:n,traceKey:o,id:s}=t;this.value=n,this.guestState=!1,this.incorrectStateBindError=!1,this.traceKey=o,this.id=s,this.virtualCollection=new Set,this.fcCollection=new Set,this.effectCollection=new Set,this.nameProp=null,this._identityHash=MCState.computeShallowIdentity(n),this._version=1}setPassport(t){this.passport=t}set(t){if(t===this.value)return;const e=typeof this.value,n=typeof t;if(null!==this.value&&"object"===e||null!==t&&"object"===n){let e=!1;if(Array.isArray(this.value)&&Array.isArray(t)){if(this.value.length===t.length){let n=!0;for(let e=0;e<this.value.length;e++)if(this.value[e]!==t[e]){n=!1;break}n&&(e=!0)}if(!e&&t.length>500){MCState.computeShallowIdentity(t)===this._identityHash&&(e=!0)}}else if(!Array.isArray(this.value)&&!Array.isArray(t)){const n=this.value&&"object"==typeof this.value?Object.keys(this.value):[],o=t&&"object"==typeof t?Object.keys(t):[];if(n.length===o.length){let o=!0;for(let e=0;e<n.length;e++){const s=n[e];if(!Object.prototype.hasOwnProperty.call(t,s)||this.value[s]!==t[s]){o=!1;break}}o&&(e=!0)}if(!e&&n.length>200){MCState.computeShallowIdentity(t)===this._identityHash&&(e=!0)}}if(e)return}else;MCState.deepEqual(t,this.value)||this.passport&&(this.value=t,this.passport.value=this.value,this._version++,this._identityHash=MCState.computeShallowIdentity(t))}get(){return MCState.deepClone(this.value)}initial(){this.passport.value=this.value}static computeShallowIdentity(t){if(null===t)return"null";const e=typeof t;if("object"!==e)return`p:${e}:${String(t)}`;if(t instanceof Date)return`D:${t.getTime()}`;if(t instanceof RegExp)return`R:${t.source}:${t.flags}`;if(Array.isArray(t)){const e=t.length,n=8;let o=[`A:${e}`];const s=Math.min(n,e);for(let e=0;e<s;e++)o.push(MCState._tokenForShallow(t[e]));if(e>2*n){o.push("..");for(let s=e-n;s<e;s++)o.push(MCState._tokenForShallow(t[s]))}else for(let n=s;n<e;n++)o.push(MCState._tokenForShallow(t[n]));return o.join("|")}if(t instanceof Map){let e=[`M:${t.size}`],n=0;for(const[o,s]of t)if(e.push(`${MCState._tokenForShallow(o)}=>${MCState._tokenForShallow(s)}`),++n>=8)break;return e.join("|")}if(t instanceof Set){let e=[`S:${t.size}`],n=0;for(const o of t)if(e.push(MCState._tokenForShallow(o)),++n>=8)break;return e.join("|")}const n=Object.keys(t),o=n.length;let s=[`O:${o}`];const i=n.slice(0,12);for(const e of i)s.push(`${e}=${MCState._tokenForShallow(t[e])}`);return o>12&&s.push(".."),s.join("|")}static _tokenForShallow(t){if(null===t)return"null";const e=typeof t;return"object"===e?`obj#${MCState._getObjectId(t)}`:`${e}:${String(t)}`}static _getObjectId(t){if(null===t||"object"!=typeof t)return 0;let e=MCState._objIdMap.get(t);return e||(e=MCState._nextObjId++,MCState._objIdMap.set(t,e)),e}static deepEqual(t,e){if(t===e)return!0;if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return!1;if(t instanceof Date&&e instanceof Date)return t.getTime()===e.getTime();if(t instanceof RegExp&&e instanceof RegExp)return t.source===e.source&&t.flags===e.flags;if(t instanceof Map&&e instanceof Map){if(t.size!==e.size)return!1;for(const[n,o]of t)if(!e.has(n)||!MCState.deepEqual(o,e.get(n)))return!1;return!0}if(t instanceof Set&&e instanceof Set){if(t.size!==e.size)return!1;for(const n of t){let t=!1;for(const o of e)if(MCState.deepEqual(n,o)){t=!0;break}if(!t)return!1}return!0}const n=new WeakMap;return function t(e,o){if(e===o)return!0;if("object"!=typeof e||null===e||"object"!=typeof o||null===o)return!1;if(e instanceof Date&&o instanceof Date)return e.getTime()===o.getTime();if(e instanceof RegExp&&o instanceof RegExp)return e.source===o.source&&e.flags===o.flags;if(n.has(e))return n.get(e)===o;n.set(e,o);const s=Array.isArray(e),i=Array.isArray(o);if(s!==i)return!1;if(s&&i){if(e.length!==o.length)return!1;for(let n=0;n<e.length;n++)if(!t(e[n],o[n]))return!1;return!0}const r=Object.keys(e),c=Object.keys(o);if(r.length!==c.length)return!1;for(let n=0;n<r.length;n++){const s=r[n];if(!Object.prototype.hasOwnProperty.call(o,s)||!t(e[s],o[s]))return!1}return!0}(t,e)}static deepClone(t){if("function"==typeof structuredClone)try{return structuredClone(t)}catch(t){}const e=new WeakMap;return function t(n){if(null===n||"object"!=typeof n)return n;if(e.has(n))return e.get(n);if(n instanceof Date){const t=new Date(n.getTime());return e.set(n,t),t}if(n instanceof RegExp){const t=new RegExp(n.source,n.flags);return e.set(n,t),t}if(Array.isArray(n)){const o=[];e.set(n,o);for(let e=0;e<n.length;e++)o[e]=t(n[e]);return o}if(n instanceof Map){const o=new Map;e.set(n,o);for(const[e,s]of n)o.set(t(e),t(s));return o}if(n instanceof Set){const o=new Set;e.set(n,o);for(const e of n)o.add(t(e));return o}const o={};e.set(n,o);const s=Object.keys(n);for(let e=0;e<s.length;e++){const i=s[e];o[i]=t(n[i])}return o}(t)}}class MCLog{component;constructor(t){t?this.component=t:console.error("Ошибка инициализации логирования для ресурсов MC.")}error(t,e){const n=`[${this.component.constructor.name}]`;console.groupCollapsed(`%c${n} ${t}`,"color: #ff5959; font-weight: bold;");for(const t of e)console.error(t);console.groupEnd()}warn(t,e){const n=`[${this.component.constructor.name}]`;console.groupCollapsed(`%c${n} ${t}`,"color: #ff8500; font-weight: bold;");for(const t of e)console.warn(t);console.groupEnd()}}class MCEngine{mc;"competitionСounter";constructor(t){this.mc=t,this.diff=new MCDiff(this.mc),this.competitionСounter=!1,this.count=0}handlerRender(t,e,n,o){let s={};n||(n="obj");return new Proxy(t,{get:(o,i)=>"object"!=typeof t[i]?t[i]:(void 0===s[i]&&(s[i]=this.handlerRender(t[i],e,`${n}.${i}`)),Reflect.get(...arguments)),set:(n,s)=>{try{if(this.mc.getCurrentRenderingInstance()){let e=this.mc;return"MC"!==e.constructor.name&&(e=e.mc),e.listPendingRedrawRequests.add(o.id),t[s]}return e(o,this.mc,this),t[s]}catch(t){console.log(t)}}})}jqToHtml(t){if(!t)return null;const[e]=t;return e||null}diffing(t){const e=t.draw(this.getArrayValuesStates(t),t.props),n=this.jqToHtml(e)??(new MC_Element).createEmptyElement();n.instanceMC=t.id,n.instanceMCtype="fn",t.HTML=this.diff.start(t.HTML,n)}formationStates(t){const e={};for(const n of t.normalized.states)n.incorrectStateBindError||(n.local,e[n.nameProp]=[n.get(),t=>n.set(t),n]);return e}diffingComponent(t){"MC"!==this.mc.constructor.name&&(this.mc=this.mc.mc),this.mc.setCurrentRenderingInstance(t.key);const e=this.formationStates(t),n=t.draw.call(t.component,e,t.normalized.props,t);this.mc.resetCurrentRenderingInstance();const o=this.jqToHtml(n)??(new MC_Element).createEmptyElement();o.instanceMC=t.id,o.instanceMCtype="mc_component",t.HTML=this.diff.start(t.HTML,o),this.mc.listPendingRedrawRequests.size&&(this.mc.listPendingRedrawRequests.forEach((t=>{const e=this.mc.getStateID(t);e.passport&&(e.passport.value=e.value)})),this.mc.listPendingRedrawRequests.clear())}rerender(t,e="fn"){let n=null;if("mc_component"===e){"MC"!==this.mc.constructor.name&&(this.mc=this.mc.mc),this.mc.setCurrentRenderingInstance(t.component.uniquekey);const e=this.formationStates(t),o=t.draw.call(t.component,e,t.normalized.props,t);this.mc.deleteKeyCurrentRenderingInstance(t.component.uniquekey),n=this.jqToHtml(o)??(new MC_Element).createEmptyElement(),n.instanceMC=t.id,n.instanceMCtype="mc_component",t.HTML=n}else{const e=t.draw(this.getArrayValuesStates(t),t.props);n=this.jqToHtml(e)??(new MC_Element).createEmptyElement(),n.instanceMC=t.id,n.instanceMCtype="fn",t.HTML=n}return t.HTML}render(t,e,n){const o=Boolean(t.fcCollection.size),s=Boolean(t.virtualCollection.size),i=Boolean(t.effectCollection.size);o&&n.renderFunctionContainer(t,e),s&&n.renderComponentWork(t,e),i&&n.runEffectWork(t,e),"MC"!==e.constructor.name&&(e=e.mc),e.scheduleCleanDeadVDOM()}controlledRender(t,e="mc_component"){"mc_component"!==e?this.diffing(t):this.diffingComponent(t)}getArrayValuesStates(t){return Array.from(t.states.values())}renderFunctionContainer(t,e){"MC"!==e.constructor.name&&(e=e.mc),t.fcCollection.forEach((n=>{const o=e.fcCollection.get(n.effectKey);o.states.get(t.id)!==t.value&&(o.states.set(t.id,t.value),this.diffing(o))}))}renderComponentWork(t,e){"MC"!==e.constructor.name&&(e=e.mc),t.virtualCollection.forEach((n=>{const o=e.componentCollection.get(n.effectKey);o.states.get(t.id)!==t.value&&(o.states.set(t.id,t.value),this.diffingComponent(o))}))}runEffectWork(t,e){"MC"!==e.constructor.name&&(e=e.mc),t.effectCollection.forEach((n=>{const o=e.effectCollection.get(n.effectKey);if(o.states.get(t.id)!==t.value){o.states.set(t.id,t.value);const e=o.run(this.getArrayValuesStates(o),o.options);e&&(o.unmountCaller=e)}}))}registrController(t){const e={value:t.id},n=this.handlerRender(e,this.render,"",t);t.setPassport(n)}}class MC_Element{constructor(t){return this.getComponent(t)}setAttributes(t){t.HTML.setAttribute("style","height: 0; width: 0; display: none;")}createEmptyElement(){const t=document.createElement("mc");return t.setAttribute("style","height: 0; width: 0; display: none;"),t}getComponent(t){return t}}class ServiceDiff{serviceArrtibute;constructor(){this.serviceArrtibute=new Set,this.serviceArrtibute.add("mc_rnd_model_controlled")}checkServiceAttribute(t){if(this.serviceArrtibute.has(t))return!0}}class EventDiff{diffEvents(t,e,n){const o=t.__mcEvents||{},s=e.__mcEvents||{},i={},r=[];for(const t in s)i[t]=s[t];for(const t in o)r.push(t);return{set:i,remove:r,ctx:n}}applyEvents(t,e){if(t){e.__mcBound=e.__mcBound||{},(t.remove||[]).forEach((t=>{e.__mcBound[t]&&(e.__mcBound[t].forEach((n=>{$(e).unbind(t)})),delete e.__mcBound[t])}));for(const[n,o]of Object.entries(t.set||{}))if(o&&o.length)for(let t of o)$(e).on(n,t),e.__mcBound[n]=e.__mcBound[n]||[],e.__mcBound[n].push(t)}}}class AttrDiff{serviceDiff;mc;constructor(t,e){this.serviceDiff=t,this.mc=e}diffAttributes(t,e,n){const o=t.attributes?Array.from(t.attributes):[],s=e.attributes?Array.from(e.attributes):[],i={},r=[],c=new Set(["checked","selected","disabled","readonly","multiple","required","open","hidden"]);for(const e of s){if(c.has(e.name))continue;t.getAttribute(e.name)!==e.value&&(i[e.name]=e.value)}for(const t of o)c.has(t.name)||e.hasAttribute(t.name)||r.push(t.name);if(1===t.nodeType&&1===e.nodeType){const n=(e.tagName||"").toLowerCase();if("input"===n||"textarea"===n||"select"===n){const n=null!=t.value?String(t.value):t.getAttribute("value"),o=null!=e.value?String(e.value):e.getAttribute("value");n!==o&&(i.value=null==o?"":o)}if("input"===n&&("checkbox"===e.type||"radio"===e.type)){const n=!!t.checked,o=!!e.checked;n!==o&&(o?i.checked="checked":r.push("checked"))}if("option"===n){const n=!!t.selected,o=!!e.selected;n!==o&&(o?i.selected="selected":r.push("selected"))}}if(r.length){const t=[],e=new Set;for(const n of r)n in i||e.has(n)||(e.add(n),t.push(n));r.length=0,Array.prototype.push.apply(r,t)}return{set:i,remove:r,ctx:n}}applyAttributes(t,e){if(t){for(const[n,o]of Object.entries(t.set||{}))if("value"!==n)if("checked"!==n)if("selected"!==n)null==o?e.removeAttribute(n):e.setAttribute(n,String(o));else{const t=!0===o||"selected"===o||"true"===o;"selected"in e&&(e.selected=!!t),t?e.setAttribute("selected","selected"):e.removeAttribute("selected")}else{const t=!0===o||"checked"===o||"true"===o;"checked"in e&&(e.checked=!!t),t?e.setAttribute("checked","checked"):e.removeAttribute("checked")}else{try{"value"in e&&(e.value=o)}catch(t){}if(null==o||""===o?e.removeAttribute("value"):e.setAttribute("value",String(o)),e.tagName&&"select"===e.tagName.toLowerCase()){const t=String(o);for(const n of e.options||[]){const e=n.value===t;n.selected=e,e?n.setAttribute("selected","selected"):n.removeAttribute("selected")}}}for(const n of t.remove||[])if("checked"!==n){if("value"!==n)"selected"!==n?e.removeAttribute(n):("selected"in e&&(e.selected=!1),e.removeAttribute("selected"));else if("value"in e&&(e.value=""),e.removeAttribute("value"),e.tagName&&"select"===e.tagName.toLowerCase())for(const t of e.options||[])t.selected=!1,t.removeAttribute("selected")}else"checked"in e&&(e.checked=!1),e.removeAttribute("checked")}}}class StyleDiff{diffStyles(t,e,n){const o=t.getAttribute&&t.getAttribute("style")||"",s=e.getAttribute&&e.getAttribute("style")||"";return o!==s?{set:s,ctx:n}:{ctx:n}}applyStyles(t,e){t&&"set"in t&&e.setAttribute("style",t.set)}}class ClassDiff{diffClasses(t,e,n){const o=t.getAttribute&&t.getAttribute("class")||"",s=e.getAttribute&&e.getAttribute("class")||"";return o!==s?{set:s,ctx:n}:{ctx:n}}applyClasses(t,e){t&&"set"in t&&e.setAttribute("class",t.set)}}class MasterDiff{attrDiff;styleDiff;classDiff;serviceDiff;mc;constructor(t,e,n,o,s){this.attrDiff=t,this.styleDiff=e,this.classDiff=n,this.eventDiff=o,this.mc=s}cleanupVDOM(t,e){if("MC"!==this.mc.constructor.name&&(this.mc=this.mc.mc),"fn"===t.instanceMCtype){const n=t.instanceMC,o=this.mc.fcCollection.get(this.mc.fcIdsCollection.get(n));return o&&(o.HTML=null),"fn"===e.instanceMCtype&&e.instanceMC&&(t.instanceMC=e.instanceMC),void(e.instanceMC||(t.instanceMC=void 0))}if("mc_component"===t.instanceMCtype){const n=t.instanceMC,o=this.mc.componentCollection.get(this.mc.componentIdsCollection.get(n));o&&(o.HTML=null),"mc_component"===e.instanceMCtype&&e.instanceMC&&(t.instanceMC=e.instanceMC),e.instanceMC||(t.instanceMC=void 0)}}diffNode(t,e,n){const o=Object.assign({level:0,path:""},n);if(!t&&e)return{type:"ADD",node:e,ctx:o};if(t&&!e)return{type:"REMOVE",ctx:o};if(!t&&!e)return{type:"NONE",ctx:o};if(t.instanceMC&&e.instanceMC&&t.instanceMC!==e.instanceMC&&this.cleanupVDOM(t,e),t.instanceMC&&!e.instanceMC&&this.cleanupVDOM(t,e),!t.instanceMC&&e.instanceMC&&(t.instanceMC=e.instanceMC,t.instanceMCtype=e.instanceMCtype),t.nodeType!==e.nodeType)return{type:"REPLACE",node:e,ctx:o};if(t.nodeType===Node.TEXT_NODE)return t.textContent!==e.textContent?{type:"TEXT",text:e.textContent,ctx:o}:{type:"NONE",ctx:o};if(t.nodeType===Node.COMMENT_NODE)return t.textContent!==e.textContent?{type:"COMMENT",text:e.textContent,ctx:o}:{type:"NONE",ctx:o};if(t.nodeType===Node.DOCUMENT_FRAGMENT_NODE||t.nodeType===Node.DOCUMENT_NODE||t.nodeType===Node.DOCUMENT_TYPE_NODE)return this.diffChildren(t,e,o);if(t.nodeType===Node.ELEMENT_NODE){if(t.nodeName!==e.nodeName)return{type:"REPLACE",node:e,ctx:o};const n=this.attrDiff.diffAttributes(t,e,o),s=this.styleDiff.diffStyles(t,e,o),i=this.classDiff.diffClasses(t,e,o),r=this.eventDiff.diffEvents(t,e,o);t.instanceMC&&e.instanceMC&&t.instanceMC!==e.instanceMC&&(t.instanceMC=e.instanceMC);return{type:"UPDATE",attrPatch:n,stylePatch:s,classPatch:i,eventPatch:r,childrenPatch:this.diffChildren(t,e,o),ctx:o}}return{type:"REPLACE",node:e,ctx:o}}diffChildren(t,e,n){const o=Object.assign({},n,{level:(n.level||0)+1}),s=Array.from(t.childNodes),i=Array.from(e.childNodes),r=Math.max(s.length,i.length),c=[];for(let t=0;t<r;t++){const e=o.path+"/"+t;c.push(this.diffNode(s[t],i[t],{...o,path:e}))}return{type:"CHILDREN",patches:c,ctx:o}}}class PatchMaster{attrDiff;styleDiff;classDiff;serviceDiff;eventDiff;mc;constructor(t,e,n,o,s){this.attrDiff=t,this.styleDiff=e,this.classDiff=n,this.eventDiff=o,this.mc=s}reconnectingVDOM(t){const e=t=>{if(t.instanceMC){if("fn"===t.instanceMCtype){const e=t.instanceMC,n=this.mc.fcCollection.get(this.mc.fcIdsCollection.get(e));n&&(n.HTML=t)}if("mc_component"===t.instanceMCtype){const e=t.instanceMC;"MC"!==this.mc.constructor.name&&(this.mc=this.mc.mc);const n=this.mc.componentCollection.get(this.mc.componentIdsCollection.get(e));n&&(n.HTML=t)}}};1===t.nodeType&&t.instanceMC&&e(t);const n=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,{acceptNode:t=>t.instanceMC?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP},!1);let o=n.nextNode();for(;o;)e(o),o=n.nextNode()}applyPatch(t,e,n){if(!t)return e;const o=Object.assign({level:0,path:""},n);switch(t.type){case"ADD":return e&&e.parentNode&&e.parentNode.appendChild(t.node),t.node;case"REMOVE":return e&&e.parentNode&&(e.parentNode.removeChild(e),this.reconnectingVDOM(t.node)),null;case"REPLACE":return e&&e.parentNode?(e.parentNode.replaceChild(t.node,e),this.reconnectingVDOM(t.node),t.node):t.node;case"TEXT":if(e&&e.nodeType===Node.TEXT_NODE)return e.textContent=t.text,e;if(e&&e.parentNode){const n=document.createTextNode(t.text);return e.parentNode.replaceChild(n,t.node),n}return document.createTextNode(t.text);case"COMMENT":if(e&&e.nodeType===Node.COMMENT_NODE)return e.nodeValue=t.text,e;if(e&&e.parentNode){const n=document.createComment(t.text);return e.parentNode.replaceChild(n,e),n}return document.createComment(t.text);case"UPDATE":return this.attrDiff.applyAttributes(t.attrPatch,e),this.styleDiff.applyStyles(t.stylePatch,e),this.classDiff.applyClasses(t.classPatch,e),this.eventDiff.applyEvents(t.eventPatch,e),this.applyPatch(t.childrenPatch,e,o),this.reconnectingVDOM(e),e;case"CHILDREN":return this._applyChildren(t.patches,e,o),e;default:return e}}_applyChildren(t,e,n){for(let o=0;o<t.length;o++){const s=t[o],i=e.childNodes[o];i||!s||"ADD"!==s.type?i&&s&&"REMOVE"===s.type?(--o,e.removeChild(i)):!i&&s||i&&s&&(this.applyPatch(s,i,n),this.reconnectingVDOM(i)):(this.reconnectingVDOM(s.node),e.appendChild(s.node))}for(let n=e.childNodes.length;n<t.length;n++){const o=t[n];o&&"ADD"===o.type&&(this.reconnectingVDOM(o.node),e.appendChild(o.node))}}}class MCDiff{master;patch;constructor(t){const e=new ServiceDiff,n=new AttrDiff(e,t),o=new StyleDiff(e),s=new ClassDiff(e),i=new EventDiff;this.master=new MasterDiff(n,o,s,i,t),this.patch=new PatchMaster(n,o,s,i,t)}start(t,e){try{const n=this.master.diffNode(t,e,{level:0,path:""}),o=this.patch.applyPatch(n,t,{level:0,path:""});return globalThis.logOn&&console.log(o),o}catch(t){throw t}}}class MC_Component{mc;constructor(t){this.mc=t}createNewInstance(t){const e=new t.component(t.props,t.context,t.uniquekey);return e.mc=this.mc,e}createSignatureComponent(t,e){const n=this.createNewInstance(t);n.uniquekey=t.uniquekey,n.parentKey=this.mc.getCurrentRenderingInstance();const o={draw:n.render,mounted:n.mounted?n.mounted:()=>{},unmounted:n.unmounted?n.unmounted:()=>{},key:t.key,id:e,states:new Map,context:t.context,HTML:(new MC_Element).createEmptyElement(),normalized:t,component:n};for(const s in n)if(n[s]instanceof MCState){const i=n[s];i.local&&!i.traceKey&&(i.traceKey=`lcl_state_${t.key}`,i.nameProp=s,t.states.push(n[s])),n.componentCollection.set(t.key,o),n.componentIdsCollection.set(e,t.key)}return this.mc.componentCollection.set(t.key,o),this.mc.componentIdsCollection.set(e,t.key),o}register(t,e){const n=this.createSignatureComponent(t,e);if(t.states.length)for(const e of t.states)this.mc.isStateLike(e)?(e.virtualCollection.add({effectKey:n.key}),n.states.set(e.id,e.value)):this.mc.log.error("Неверный стейт",["Переданная сигнатура состояния неверна. Проверьте данные которые вы передали в зависимости"]);return this.start(n),n.HTML.instanceMC=n.id,n.HTML.instanceMCtype="mc_component",n.HTML}start(t){this.mc.getCurrentRenderingInstance()?t.HTML=this.mc.engine.rerender(t,"mc_component"):this.mc.engine.controlledRender(t,"mc_component")}}class MCcontext{id;key;virtualCollection;constructor(t){const{id:e,key:n}=t;this.id=e,this.key=n??null,this.virtualCollection=new Set}create(t,e,n){const o={component:t,parent_id:this.id,key:e,identifier:n};return this.virtualCollection.add(o),[{context:this.id,id_element:e},o]}}const _mc_instance_restore_object={instance:null};class MC{original$;mc;stateList;mc_state_global;mc_context_global;_cleaningScheduled;fcCollection;fcIdsCollection;componentCollection;componentIdsCollection;componentHandler;currentRenderingInstance;listPendingRedrawRequests;constructor(){this.log=new MCLog(this),this.engine=new MCEngine(this),this.componentHandler=new MC_Component(this),this.stateList=new Map,this.fcCollection=new Map,this.fcIdsCollection=new Map,this.effectCollection=new Map,this.effectIdsCollection=new Map,this.componentCollection=new Map,this.componentIdsCollection=new Map,this.currentRenderingInstance=new Set,this.COUNTER_CLEAR=150,this.checkCountClearedFunctionContainers=this.COUNTER_CLEAR,this.mc_state_global=new Set,this.mc_context_global=new Set,this._cleaningScheduled=!1,this.listPendingRedrawRequests=new Set,window.$?this.original$=window.$:this.log.error("JQuery функция не была обнаружена!",["Для работы MC данного выпуска необходимо подлючение JQuery версии 1.5 или выше","Проверьте подключение библиотеки, либо используйте init после её определения"])}static init(){if(this.mc)return this.mc.log.warn("На данной странице уже инициализирован Micro Component",["Вы пытаетесь инициализировать MC на странице больше одного раза.","Такое действие не имеет цели для обработчиков МС"]),void this.mc.use();this.mc=new MC,_mc_instance_restore_object.instance=this.mc,window.$.MC=this.mc.use.bind(this),window.$.MC.memo=this.mc.useMemo.bind(this),window.$.MC.effect=this.mc.useEffect.bind(this),window.iMC=this.mc,window.iMC.mc=this;const t=window.$.fn.on;window.$.fn.on=function(e,n,o,s){let i;if("function"==typeof n)i=n;else{if("function"!=typeof s)return t.apply(this,arguments);i=s}const r=this[0];return r&&(r.__mcBound=r.__mcBound||{},r.__mcEvents=r.__mcEvents||{},r.__mcBound[e]||(r.__mcBound[e]=[]),r.__mcEvents[e]||(r.__mcEvents[e]=[]),r.__mcBound[e].push(i),r.__mcEvents[e].push(i)),t.apply(this,arguments)}}scheduleCleanDeadVDOM(){if(this._cleaningScheduled)return;this._cleaningScheduled=!0;const t=async()=>{try{await this.checkAllDeadsFunctionsContainers(),await this.checkAllDeadsClassComponentsContainers()}finally{this._cleaningScheduled=!1}};"requestIdleCallback"in window?requestIdleCallback(t,{timeout:500}):setTimeout(t,200)}static enableFragmentShortSyntax(){if("undefined"==typeof window||!window.$||!window.$.fn||!window.$.fn.init)throw new Error("jQuery не найден в window.$ — нельзя включить fragment short-syntax");if(window.$.mcInitPatched)return;const t=window.$,e=t.fn.init;t.mcOriginalInit||(t.mcOriginalInit=e),t.fn.init=function(t,n,o){if("string"==typeof t&&"</>"===t){const t=e.call(this),n=document.createDocumentFragment();return t[0]=n,t.length=1,t._isDocumentFragment=!0,t}return e.call(this,t,n,o)},t.fn.init.prototype=e.prototype,t.mcInitPatched=!0,t.mcLogPatched||(t.mcLogPatched=!0)}static disableFragmentShortSyntax(){if("undefined"==typeof window||!window.$||!window.$.fn)return;const t=window.$;t.mcInitPatched&&(t.mcOriginalInit&&(t.fn.init=t.mcOriginalInit,t.fn.init.prototype=t.mcOriginalInit.prototype||t.fn,delete t.mcOriginalInit),delete t.mcInitPatched,delete t.mcLogPatched)}static uState(t,e,n){if(!e)return void this.mc.log.error("Ошибка генерации ключа",["Не удалось получить ключ для состояния"]);const[o]=this.mc.getState(e);return o?(n&&o.set(t),o):this.mc.createState(t,e)}static uContext(t){if(!t)return void this.mc.log.error("Ошибка генерации ключа",["Не удалось получить ключ для состояния"]);const e=this.mc.getContext(t);return e||this.mc.createContext(t)}static getState(t){const e=[];return t?(this.mc.mc_state_global.forEach((n=>{n.traceKey===t&&e.push(n)})),e):(this.mc.mc_state_global.forEach((t=>{e.push(t)})),e)}static getContext(t){let e;return this.mc.mc_context_global.forEach((n=>{n.key===t&&(e=n)})),e}setCurrentRenderingInstance(t){this.currentRenderingInstance.add(t)}getCurrentRenderingInstance(){let t=this;return"MC"!==t.constructor.name&&(t=this.mc),Array.from(t.currentRenderingInstance).join("_")}resetCurrentRenderingInstance(){let t=this;"MC"!==t.constructor.name&&(t=this.mc),t.currentRenderingInstance.clear()}deleteKeyCurrentRenderingInstance(t){let e=this;"MC"!==e.constructor.name&&(e=this.mc),e.currentRenderingInstance.delete(t)}state(t){return this.createLocallyState(t,this)}uuidv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)))}getContext(t){let e;return this.mc_context_global.forEach((n=>{n.key===t&&(e=n)})),e}getState(t){const e=[];return t?(this.mc_state_global.forEach((n=>{n.traceKey===t&&e.push(n)})),e):(this.mc_state_global.forEach((t=>{e.push(t)})),e)}getStateID(t){let e=null;return this.mc_state_global.forEach((n=>{n.id===t&&(e=n)})),e}createState(t,e){const n={value:t,traceKey:e,id:this.uuidv4()},o=new MCState(n);return o.nameProp=e,this.engine.registrController(o),this.mc_state_global.add(o),o}createContext(t){const e={id:this.uuidv4(),key:t},n=new MCcontext(e);return this.mc_context_global.add(n),n}createLocallyState(t,e){const n={value:t,id:this.uuidv4(),localKey:null},o=new MCState(n,e);return this.engine.registrController(o),_mc_instance_restore_object.instance.mc_state_global.add(o),o}checkTypeEntity(t){return t.prototype instanceof MC?"mc_component":"Function"===t.constructor.name?"function":(this.log.error("Ошибка определения компонента",["Переданные параметры для функции определения не смогли получить сигнатуру компонента","Проверьте правильность создания своих ресурсов"]),"error")}processFunction(t){const{component:e,instruction:n,key:o,props:s,states:i}=this.normilizeArgs(t);if("mc_inst_effect"===n){const t=this.getEffectVirtual(e,o);return t?void(t.parent&&(t.run=e)):(this.createEffect(e,i,o),null)}const r=this.getFunctionContainerVirtual(e,o);return r&&r.HTML.isConnected?(r.props=s,this.workFunctionContainer(r,"mc_inst_memo"===n)):this.createFunctionContainer(e,s,i,o)}simpleHash(t){let e=5381;for(let n=0;n<t.length;n++)e=(e<<5)+e+t.charCodeAt(n);return(e>>>0).toString(16)}generateComponentKey(t,e){const n=t.toString().trim();return this.simpleHash(n)+`${e}`}createSignatureFunctionContainer(t,e,n,o){const s=this.generateComponentKey(t,o),i={draw:t,props:e,key:s,id:n,states:new Map,HTML:(new MC_Element).createEmptyElement()};return this.fcCollection.set(s,i),this.fcIdsCollection.set(n,s),i}createFunctionContainer(t,e,n,o=""){const s=this.uuidv4(),i=this.createSignatureFunctionContainer(t,e,s,o);return n&&n.map((t=>{this.isStateLike(t)?(t.fcCollection.add({effectKey:i.key}),i.states.set(t.id,t.value)):this.log.error("Неверный стейт",["Переданная сигнатура состояния неверна. Проверьте данные которые вы передали в зависимости"])})),n||n.length||this.log.error("Ошибка чтения массива состояний",["Структура функционального контейнера:",`${i.draw}`,"- требует наличия массива зависимостей!","Если вам не нужны зависимости в данном компоненте, скорее всего вы нецелесообразно используете функциональные контейнеры."]),i.HTML=this.engine.rerender(i),i.HTML.instanceMC=i.id,i.HTML.instanceMCtype="fn",i.HTML}workFunctionContainer(t,e){return t?e?t.HTML:this.engine.rerender(t):null}getFunctionContainerVirtual(t,e=""){const n=this.generateComponentKey(t,e),o=this.fcCollection.get(n);return o||!1}async checkAllDeadsFunctionsContainers(t=100){const e=[];for(const[t,n]of this.fcCollection)n.HTML&&n.HTML.isConnected||e.push(t);for(let n=0;n<e.length;n+=t){const o=e.slice(n,n+t);for(const t of o){const e=this.fcCollection.get(t);if(e){this.fcIdsCollection.delete(e.id);for(const[n]of e.states){const e=this.getStateID(n);if(e)for(const n of e.fcCollection)if(n.effectKey===t){e.fcCollection.delete(n);break}}this.fcCollection.delete(t)}}await new Promise((t=>setTimeout(t,0)))}}async checkAllDeadsClassComponentsContainers(t=100){const e=[];for(const[t,n]of this.componentCollection)n.HTML&&n.HTML?.isConnected||e.push(t);for(let n=0;n<e.length;n+=t){const o=e.slice(n,n+t);for(const t of o){const e=this.componentCollection.get(t);if(!e)continue;this.componentIdsCollection.delete(e.id);for(const[n]of e.states){const e=this.getStateID(n);if(e)for(const n of e.virtualCollection)if(n.effectKey===t){e.virtualCollection.delete(n),e.local&&!e.virtualCollection.length&&this.mc_state_global.delete(e);break}}const n=[];for(const[t,o]of this.effectCollection)if(o.parent===e.key){o.unmountCaller(),n.push(t);for(const[e]of o.states){const n=this.getStateID(e);if(n)for(const e of n.effectCollection)e.effectKey===t&&n.effectCollection.delete(e)}}for(const t of n)this.effectCollection.delete(t);this.componentCollection.delete(t)}await new Promise((t=>setTimeout(t,0)))}}createSignatureEffect(t,e,n){const o=this.getCurrentRenderingInstance(),s=o?`${this.generateComponentKey(t,n)}__${o}`:this.generateComponentKey(t,n),i={run:t,key:s,id:e,states:new Map,parent:o||null,unmountCaller:()=>{}};return this.effectCollection.set(s,i),this.effectIdsCollection.set(e,s),i}createEffect(t,e,n=""){const o=this.uuidv4(),s=this.createSignatureEffect(t,o,n);if(e&&e.map((t=>{this.isStateLike(t)?(t.effectCollection.add({effectKey:s.key}),s.states.set(t.id,t.value)):this.log.error("Неверный стейт",["Переданная сигнатура состояния неверна. Проверьте данные которые вы передали в зависимости"])})),!e.length){const t=s.run(s.states.values());t&&(s.unmountCaller=t)}}getEffectVirtual(t,e=""){const n=this.generateComponentKey(t,e),o=this.getCurrentRenderingInstance();let s=null;return s=this.effectCollection.get(n),s||(s=this.effectCollection.get(`${n}__${o}`)),s||!1}hashString(t){let e=5381;for(let n=0;n<t.length;n++)e=33*e^t.charCodeAt(n);return(e>>>0).toString(36)}serializeForHash(t){if(null==t)return"null";if("string"==typeof t)return`"${t}"`;if("number"==typeof t||"boolean"==typeof t)return String(t);if(Array.isArray(t))return"["+t.map((t=>this.serializeForHash(t))).join(",")+"]";if("object"==typeof t){return"{"+Object.keys(t).sort().map((e=>`"${e}":${this.serializeForHash(t[e])}`)).join(",")+"}"}return String(t)}generateKeyFromNormalized(t){const e=[];t.component&&e.push(t.component.name||t.component.toString());const n=t=>{const e=new WeakSet,n=t=>{if(null===t)return"null";if(void 0===t)return"undefined";const s=typeof t;if("string"===s)return"string";if("number"===s)return Number.isNaN(t)?"nan":"number";if("boolean"===s)return"boolean";if("function"===s)return"function";if("symbol"===s)return"symbol";if("bigint"===s)return"bigint";if(t instanceof Date)return"Date";if(t instanceof RegExp)return"RegExp";if(t instanceof Map){const e=[],s=[];for(const[o,i]of t.entries())e.push(n(o)),s.push(n(i));return`Map<${o(e).join(",")}|${o(s).join(",")}>`}if(t instanceof Set){const e=[];for(const o of t.values())e.push(n(o));return`Set<${o(e).join(",")}>`}if(Array.isArray(t)){if(e.has(t))return"Array<...>";e.add(t);const s=t.map(n);return`Array<${o(s).join(",")}>`}if("object"===s){if(e.has(t))return"Object<...>";e.add(t);return`{${Object.keys(t).sort().map((e=>`${e}:${n(t[e])}`)).join(",")}}`}return s},o=t=>Array.from(new Set(t)).sort();return n(t)};return t.props&&Object.keys(t.props).length>0&&e.push(n(t.props)),t.states&&t.states.length>0&&e.push("["+t.states.map((t=>n(t&&t.value))).join("|")+"]"),t.context&&e.push(n(t.context)),this.hashString(e.join("|"))}isStateLike(t){return!!t&&(t instanceof MCState||"function"==typeof t.get&&"function"==typeof t.set)}normilizeArgs(t){const e={component:null,props:{},states:[],key:void 0,context:null,instruction:null};for(const n of t)if(n&&n.prototype instanceof MC||n&&"Function"===n.constructor.name)e.component=n;else if(this.isStateLike(n)){if(n.local&&!Array.from(t).includes("mc_inst_effect")){n.incorrectStateBindError=!0,this.log.error("Неправильное назначение",["Локальное состояние компонента не может быть привязано к дочерним компонентам.\n Привязка приведёт к избыточным ререндерингам и потенциальным непредсказуемым побочным эффектам.\n Используйте пропсы или контекстное/глобальное состояние для передачи данных вниз по дереву компонентов.",`traceKey:: ${n.traceKey}`]);continue}e.states.push(n)}else if(Array.isArray(n)&&n.every((t=>this.isStateLike(t)))){let o=!1;if(n.forEach((e=>{e.local&&!Array.from(t).includes("mc_inst_effect")&&(o=!0,e.incorrectStateBindError=!0,this.log.error("Неправильное назначение",["Локальное состояние компонента не может быть привязано к дочерним компонентам.\n Привязка приведёт к избыточным ререндерингам и потенциальным непредсказуемым побочным эффектам.\n Используйте пропсы или контекстное/глобальное состояние для передачи данных вниз по дереву компонентов.",`traceKey:: ${e.traceKey}`]))})),o)continue;e.states.push(...n)}else"mc_inst_effect"!==n&&"mc_inst_memo"!==n?"string"!=typeof n&&"number"!=typeof n?n instanceof MCcontext?e.context=n:null==n||"object"!=typeof n?null!=n&&(e.props=n):e.props=Object.assign({},n):e.key=n:e.instruction=n;return e}processComponent(t){const e=this.normilizeArgs(t);e.uniquekey=e.key?e.key:this.generateKeyFromNormalized(e),e.key=e.uniquekey;const n=this.getCurrentRenderingInstance(),o=n?`${n}_${e.key}`:e.key;if(e.key=o,this.componentCollection.has(e.key)){const t=this.componentCollection.get(e.key);return t.normalized.props=e.props,this.engine.rerender(t,"mc_component")}const s=this.uuidv4();return this.componentHandler.register(e,s)}use(){const[t]=arguments;switch(this.mc.checkTypeEntity(t)){case"function":return this.mc.processFunction(arguments);case"mc_component":return this.mc.processComponent(arguments);default:return null}}useMemo(){return 2===arguments.length?this.mc.use.call(this,...arguments,"","mc_inst_memo"):this.mc.use.call(this,...arguments,"mc_inst_memo")}useEffect(){return 2===arguments.length?this.mc.use.call(this,...arguments,"","mc_inst_effect"):this.mc.use.call(this,...arguments,"mc_inst_effect")}}