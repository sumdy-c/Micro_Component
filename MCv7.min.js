class MCState{id;value;traceKey;virtualCollection;fcCollection;effectCollection;passport;local;guestState;incorrectStateBindError;_version=0;_identityHash=null;static _objIdMap=new WeakMap;static _nextObjId=1;constructor(t,e){e&&(this.local=e);const{value:n,traceKey:o,id:i}=t;this.value=n,this.guestState=!1,this.incorrectStateBindError=!1,this.traceKey=o,this.id=i,this.virtualCollection=new Set,this.fcCollection=new Set,this.effectCollection=new Set,this._identityHash=MCState.computeShallowIdentity(n),this._version=1}setPassport(t){this.passport=t}set(t){if(t===this.value)return;const e=typeof this.value,n=typeof t;if(null!==this.value&&"object"===e||null!==t&&"object"===n){let e=!1;if(Array.isArray(this.value)&&Array.isArray(t)){if(this.value.length===t.length){let n=!0;for(let e=0;e<this.value.length;e++)if(this.value[e]!==t[e]){n=!1;break}n&&(e=!0)}if(!e&&t.length>500){MCState.computeShallowIdentity(t)===this._identityHash&&(e=!0)}}else if(!Array.isArray(this.value)&&!Array.isArray(t)){const n=this.value&&"object"==typeof this.value?Object.keys(this.value):[],o=t&&"object"==typeof t?Object.keys(t):[];if(n.length===o.length){let o=!0;for(let e=0;e<n.length;e++){const i=n[e];if(!Object.prototype.hasOwnProperty.call(t,i)||this.value[i]!==t[i]){o=!1;break}}o&&(e=!0)}if(!e&&n.length>200){MCState.computeShallowIdentity(t)===this._identityHash&&(e=!0)}}if(e)return}else;MCState.deepEqual(t,this.value)||this.passport&&(this.value=t,this.passport.value=this.value,this._version++,this._identityHash=MCState.computeShallowIdentity(t))}get(){return MCState.deepClone(this.value)}initial(){this.passport.value=this.value}static computeShallowIdentity(t){if(null===t)return"null";const e=typeof t;if("object"!==e)return`p:${e}:${String(t)}`;if(t instanceof Date)return`D:${t.getTime()}`;if(t instanceof RegExp)return`R:${t.source}:${t.flags}`;if(Array.isArray(t)){const e=t.length,n=8;let o=[`A:${e}`];const i=Math.min(n,e);for(let e=0;e<i;e++)o.push(MCState._tokenForShallow(t[e]));if(e>2*n){o.push("..");for(let i=e-n;i<e;i++)o.push(MCState._tokenForShallow(t[i]))}else for(let n=i;n<e;n++)o.push(MCState._tokenForShallow(t[n]));return o.join("|")}if(t instanceof Map){let e=[`M:${t.size}`],n=0;for(const[o,i]of t)if(e.push(`${MCState._tokenForShallow(o)}=>${MCState._tokenForShallow(i)}`),++n>=8)break;return e.join("|")}if(t instanceof Set){let e=[`S:${t.size}`],n=0;for(const o of t)if(e.push(MCState._tokenForShallow(o)),++n>=8)break;return e.join("|")}const n=Object.keys(t),o=n.length;let i=[`O:${o}`];const s=n.slice(0,12);for(const e of s)i.push(`${e}=${MCState._tokenForShallow(t[e])}`);return o>12&&i.push(".."),i.join("|")}static _tokenForShallow(t){if(null===t)return"null";const e=typeof t;return"object"===e?`obj#${MCState._getObjectId(t)}`:`${e}:${String(t)}`}static _getObjectId(t){if(null===t||"object"!=typeof t)return 0;let e=MCState._objIdMap.get(t);return e||(e=MCState._nextObjId++,MCState._objIdMap.set(t,e)),e}static deepEqual(t,e){if(t===e)return!0;if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return!1;if(t instanceof Date&&e instanceof Date)return t.getTime()===e.getTime();if(t instanceof RegExp&&e instanceof RegExp)return t.source===e.source&&t.flags===e.flags;if(t instanceof Map&&e instanceof Map){if(t.size!==e.size)return!1;for(const[n,o]of t)if(!e.has(n)||!MCState.deepEqual(o,e.get(n)))return!1;return!0}if(t instanceof Set&&e instanceof Set){if(t.size!==e.size)return!1;for(const n of t){let t=!1;for(const o of e)if(MCState.deepEqual(n,o)){t=!0;break}if(!t)return!1}return!0}const n=new WeakMap;return function t(e,o){if(e===o)return!0;if("object"!=typeof e||null===e||"object"!=typeof o||null===o)return!1;if(e instanceof Date&&o instanceof Date)return e.getTime()===o.getTime();if(e instanceof RegExp&&o instanceof RegExp)return e.source===o.source&&e.flags===o.flags;if(n.has(e))return n.get(e)===o;n.set(e,o);const i=Array.isArray(e),s=Array.isArray(o);if(i!==s)return!1;if(i&&s){if(e.length!==o.length)return!1;for(let n=0;n<e.length;n++)if(!t(e[n],o[n]))return!1;return!0}const r=Object.keys(e),c=Object.keys(o);if(r.length!==c.length)return!1;for(let n=0;n<r.length;n++){const i=r[n];if(!Object.prototype.hasOwnProperty.call(o,i)||!t(e[i],o[i]))return!1}return!0}(t,e)}static deepClone(t){if("function"==typeof structuredClone)try{return structuredClone(t)}catch(t){}const e=new WeakMap;return function t(n){if(null===n||"object"!=typeof n)return n;if(e.has(n))return e.get(n);if(n instanceof Date){const t=new Date(n.getTime());return e.set(n,t),t}if(n instanceof RegExp){const t=new RegExp(n.source,n.flags);return e.set(n,t),t}if(Array.isArray(n)){const o=[];e.set(n,o);for(let e=0;e<n.length;e++)o[e]=t(n[e]);return o}if(n instanceof Map){const o=new Map;e.set(n,o);for(const[e,i]of n)o.set(t(e),t(i));return o}if(n instanceof Set){const o=new Set;e.set(n,o);for(const e of n)o.add(t(e));return o}const o={};e.set(n,o);const i=Object.keys(n);for(let e=0;e<i.length;e++){const s=i[e];o[s]=t(n[s])}return o}(t)}}class MCLog{component;constructor(t){t?this.component=t:console.error("Ошибка инициализации логирования для ресурсов MC.")}error(t,e){const n=`[${this.component.constructor.name}]`;console.groupCollapsed(`%c${n} ${t}`,"color: #ff5959; font-weight: bold;");for(const t of e)console.error(t);console.groupEnd()}warn(t,e){const n=`[${this.component.constructor.name}]`;console.groupCollapsed(`%c${n} ${t}`,"color: #ff8500; font-weight: bold;");for(const t of e)console.warn(t);console.groupEnd()}}class MCEngine{mc;constructor(t){this.mc=t,this.diff=new MCDiff(this.mc)}handlerRender(t,e,n,o){let i={};n||(n="obj");return new Proxy(t,{get:(o,s)=>"object"!=typeof t[s]?t[s]:(void 0===i[s]&&(i[s]=this.handlerRender(t[s],e,`${n}.${s}`)),Reflect.get(...arguments)),set:(n,i)=>{try{return e(o,this.mc,this),t[i]}catch(t){console.log(t)}}})}jqToHtml(t){if(!t)return null;const[e]=t;return e||null}diffing(t){const e=t.draw(this.getArrayValuesStates(t),t.options),n=this.jqToHtml(e)??(new MC_Element).createEmptyElement();t.HTML=this.diff.start(t.HTML,n),t.HTML.instanceMC=t.id,t.HTML.instanceMCtype="fn"}formationStates(t){const e={global:[],local:[]};for(const n of t.normalized.states)n.incorrectStateBindError||(n.local?e.local.push(n.get()):e.global.push(n.get()));return e}diffingComponent(t){"MC"!==this.mc.constructor.name&&(this.mc=this.mc.mc),this.mc.setCurrentRenderingInstance(t.key);const e=this.formationStates(t),n=t.draw.call(t.component,e,t.normalized.props,t);this.mc.resetCurrentRenderingInstance();const o=this.jqToHtml(n)??(new MC_Element).createEmptyElement();t.HTML=this.diff.start(t.HTML,o),t.HTML.instanceMC=t.id,t.HTML.instanceMCtype="mc_component"}rerender(t,e="fn"){let n=null;if("mc_component"===e){"MC"!==this.mc.constructor.name&&(this.mc=this.mc.mc),this.mc.setCurrentRenderingInstance(t.component.uniquekey);const e=this.formationStates(t),o=t.draw.call(t.component,e,t.normalized.props,t);this.mc.deleteKeyCurrentRenderingInstance(t.component.uniquekey),n=this.jqToHtml(o)??(new MC_Element).createEmptyElement(),t.HTML=n,t.HTML.instanceMC=t.id,t.HTML.instanceMCtype="mc_component"}else{const e=t.draw(this.getArrayValuesStates(t));n=this.jqToHtml(e)??(new MC_Element).createEmptyElement(),t.HTML=n,t.HTML.instanceMC=t.id,t.HTML.instanceMCtype="fn"}return t.HTML}render(t,e,n){Boolean(t.fcCollection.size)&&n.renderFunctionContainer(t,e),Boolean(t.virtualCollection.size)&&n.renderComponentWork(t,e),Boolean(t.effectCollection.size)&&n.runEffectWork(t,e)}controlledRender(t,e="mc_component"){"mc_component"!==e?this.diffing(t):this.diffingComponent(t)}getArrayValuesStates(t){return Array.from(t.states.values())}renderFunctionContainer(t,e){"MC"!==e.constructor.name&&(e=e.mc),t.fcCollection.forEach((n=>{const o=e.fcCollection.get(n.effectKey);o.states.get(t.id)!==t.value&&(o.states.set(t.id,t.value),this.diffing(o))}))}renderComponentWork(t,e){"MC"!==e.constructor.name&&(e=e.mc),t.virtualCollection.forEach((n=>{const o=e.componentCollection.get(n.effectKey);o.states.get(t.id)!==t.value&&(o.states.set(t.id,t.value),this.diffingComponent(o))}))}runEffectWork(t,e){"MC"!==e.constructor.name&&(e=e.mc),t.effectCollection.forEach((n=>{const o=e.effectCollection.get(n.effectKey);o.states.get(t.id)!==t.value&&(o.states.set(t.id,t.value),o.run(this.getArrayValuesStates(o),o.options))}))}registrController(t){const e={value:t.id},n=this.handlerRender(e,this.render,"",t);t.setPassport(n)}}class MC_Element{constructor(t){return this.getComponent(t)}setAttributes(t){t.HTML.setAttribute("style","height: 0; width: 0; display: none;")}createEmptyElement(){const t=document.createElement("mc");return t.setAttribute("style","height: 0; width: 0; display: none;"),t}getComponent(t){return t}}class ServiceDiff{serviceArrtibute;constructor(){this.serviceArrtibute=new Set,this.serviceArrtibute.add("mc_rnd_model_controlled")}checkServiceAttribute(t){if(this.serviceArrtibute.has(t))return!0}}class EventDiff{diffEvents(t,e,n){const o=t.__mcEvents||{},i=e.__mcEvents||{},s={},r=[];for(const t in i)s[t]=i[t];for(const t in o)r.push(t);return{set:s,remove:r,ctx:n}}applyEvents(t,e){if(t){e.__mcBound=e.__mcBound||{},(t.remove||[]).forEach((t=>{e.__mcBound[t]&&(e.__mcBound[t].forEach((n=>{$(e).unbind(t)})),delete e.__mcBound[t])}));for(const[n,o]of Object.entries(t.set||{}))if(o&&o.length)for(let t of o)$(e).on(n,t),e.__mcBound[n]=e.__mcBound[n]||[],e.__mcBound[n].push(t)}}}class AttrDiff{serviceDiff;mc;constructor(t,e){this.serviceDiff=t,this.mc=e}diffAttributes(t,e,n){const o=t.attributes?Array.from(t.attributes):[],i=e.attributes?Array.from(e.attributes):[],s={},r=[];for(const e of i)t.getAttribute(e.name)!==e.value&&(s[e.name]=e.value);for(const t of o)e.hasAttribute(t.name)||r.push(t.name);return{set:s,remove:r,ctx:n}}applyAttributes(t,e){if(t){for(const[n,o]of Object.entries(t.set||{}))e.setAttribute(n,o);for(const n of t.remove||[])e.removeAttribute(n)}}}class StyleDiff{diffStyles(t,e,n){const o=t.getAttribute&&t.getAttribute("style")||"",i=e.getAttribute&&e.getAttribute("style")||"";return o!==i?{set:i,ctx:n}:{ctx:n}}applyStyles(t,e){t&&"set"in t&&e.setAttribute("style",t.set)}}class ClassDiff{diffClasses(t,e,n){const o=t.getAttribute&&t.getAttribute("class")||"",i=e.getAttribute&&e.getAttribute("class")||"";return o!==i?{set:i,ctx:n}:{ctx:n}}applyClasses(t,e){t&&"set"in t&&e.setAttribute("class",t.set)}}class MasterDiff{attrDiff;styleDiff;classDiff;serviceDiff;constructor(t,e,n,o){this.attrDiff=t,this.styleDiff=e,this.classDiff=n,this.eventDiff=o}diffNode(t,e,n){const o=Object.assign({level:0,path:""},n);if(!t&&e)return{type:"ADD",node:e,ctx:o};if(t&&!e)return{type:"REMOVE",ctx:o};if(!t&&!e)return{type:"NONE",ctx:o};if(t.nodeType!==e.nodeType)return{type:"REPLACE",node:e,ctx:o};if(t.nodeType===Node.TEXT_NODE)return t.textContent!==e.textContent?{type:"TEXT",text:e.textContent,ctx:o}:{type:"NONE",ctx:o};if(t.nodeType===Node.COMMENT_NODE)return t.textContent!==e.textContent?{type:"COMMENT",text:e.textContent,ctx:o}:{type:"NONE",ctx:o};if(t.nodeType===Node.DOCUMENT_FRAGMENT_NODE||t.nodeType===Node.DOCUMENT_NODE||t.nodeType===Node.DOCUMENT_TYPE_NODE)return this.diffChildren(t,e,o);if(t.nodeType===Node.ELEMENT_NODE){if(t.nodeName!==e.nodeName)return{type:"REPLACE",node:e,ctx:o};const n=this.attrDiff.diffAttributes(t,e,o),i=this.styleDiff.diffStyles(t,e,o),s=this.classDiff.diffClasses(t,e,o),r=this.eventDiff.diffEvents(t,e,o);t.instanceMC&&e.instanceMC&&t.instanceMC!==e.instanceMC&&(t.instanceMC=e.instanceMC);return{type:"UPDATE",attrPatch:n,stylePatch:i,classPatch:s,eventPatch:r,childrenPatch:this.diffChildren(t,e,o),ctx:o}}return{type:"REPLACE",node:e,ctx:o}}diffChildren(t,e,n){const o=Object.assign({},n,{level:(n.level||0)+1}),i=Array.from(t.childNodes),s=Array.from(e.childNodes),r=Math.max(i.length,s.length),c=[];for(let t=0;t<r;t++){const e=o.path+"/"+t;c.push(this.diffNode(i[t],s[t],{...o,path:e}))}return{type:"CHILDREN",patches:c,ctx:o}}}class PatchMaster{attrDiff;styleDiff;classDiff;serviceDiff;eventDiff;mc;constructor(t,e,n,o,i){this.attrDiff=t,this.styleDiff=e,this.classDiff=n,this.eventDiff=o,this.mc=i}reconnectingVDOM(t){const e=t=>{if(t.instanceMC){if("fn"===t.instanceMCtype){const e=t.instanceMC,n=this.mc.fcCollection.get(this.mc.fcIdsCollection.get(e));n&&(n.HTML=t)}if("mc_component"===t.instanceMCtype){const e=t.instanceMC;"MC"!==this.mc.constructor.name&&(this.mc=this.mc.mc);const n=this.mc.componentCollection.get(this.mc.componentIdsCollection.get(e));n&&(n.HTML=t)}}};1===t.nodeType&&t.instanceMC&&e(t);const n=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,{acceptNode:t=>t.instanceMC?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP},!1);let o=n.nextNode();for(;o;)e(o),o=n.nextNode()}applyPatch(t,e,n){if(!t)return e;const o=Object.assign({level:0,path:""},n);switch(t.type){case"ADD":return e&&e.parentNode&&e.parentNode.appendChild(t.node),t.node;case"REMOVE":return e&&e.parentNode&&(e.parentNode.removeChild(e),this.reconnectingVDOM(t.node)),null;case"REPLACE":return e&&e.parentNode?(e.parentNode.replaceChild(t.node,e),this.reconnectingVDOM(t.node),t.node):t.node;case"TEXT":if(e&&e.nodeType===Node.TEXT_NODE)return e.textContent=t.text,e;if(e&&e.parentNode){const n=document.createTextNode(t.text);return e.parentNode.replaceChild(n,t.node),n}return document.createTextNode(t.text);case"COMMENT":if(e&&e.nodeType===Node.COMMENT_NODE)return e.nodeValue=t.text,e;if(e&&e.parentNode){const n=document.createComment(t.text);return e.parentNode.replaceChild(n,e),n}return document.createComment(t.text);case"UPDATE":return this.attrDiff.applyAttributes(t.attrPatch,e),this.styleDiff.applyStyles(t.stylePatch,e),this.classDiff.applyClasses(t.classPatch,e),this.eventDiff.applyEvents(t.eventPatch,e),this.applyPatch(t.childrenPatch,e,o),this.reconnectingVDOM(e),e;case"CHILDREN":return this._applyChildren(t.patches,e,o),e;default:return e}}_applyChildren(t,e,n){for(let o=0;o<t.length;o++){const i=t[o],s=e.childNodes[o];s||!i||"ADD"!==i.type?s&&i&&"REMOVE"===i.type?(--o,e.removeChild(s)):!s&&i||s&&i&&(this.applyPatch(i,s,n),this.reconnectingVDOM(s)):(this.reconnectingVDOM(i.node),e.appendChild(i.node))}for(let n=e.childNodes.length;n<t.length;n++){const o=t[n];o&&"ADD"===o.type&&(this.reconnectingVDOM(o.node),e.appendChild(o.node))}}}class MCDiff{master;patch;mc;constructor(t){const e=new ServiceDiff,n=new AttrDiff(e,t),o=new StyleDiff(e),i=new ClassDiff(e),s=new EventDiff;this.master=new MasterDiff(n,o,i,s),this.patch=new PatchMaster(n,o,i,s,t),this.mc=t}reconnectingVDOM(t){const e=t=>{if(t.instanceMC){if("fn"===t.instanceMCtype){const e=t.instanceMC,n=this.mc.fcCollection.get(this.mc.fcIdsCollection.get(e));n&&(n.HTML=t)}if("mc_component"===t.instanceMCtype){const e=t.instanceMC;"MC"!==this.mc.constructor.name&&(this.mc=this.mc.mc);const n=this.mc.componentCollection.get(this.mc.componentIdsCollection.get(e));n&&(n.HTML=t)}}};1===t.nodeType&&t.instanceMC&&e(t);const n=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,{acceptNode:t=>t.instanceMC?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP},!1);let o=n.nextNode();for(;o;)e(o),o=n.nextNode()}start(t,e){try{const n=this.master.diffNode(t,e,{level:0,path:""}),o=this.patch.applyPatch(n,t,{level:0,path:""});return globalThis.logOn&&console.log(o),o}catch(t){throw t}}}class MC_Component{mc;constructor(t){this.mc=t}createNewInstance(t){const e=new t.component(t.props,t.context,t.uniquekey);return e.mc=this.mc,e}createSignatureComponent(t,e){const n=this.createNewInstance(t);n.uniquekey=t.uniquekey,n.parentKey=this.mc.getCurrentRenderingInstance();const o={draw:n.render,mounted:n.mounted?n.mounted:()=>{},unmounted:n.unmounted?n.unmounted:()=>{},key:t.key,id:e,states:new Map,context:t.context,HTML:(new MC_Element).createEmptyElement(),normalized:t,component:n};for(const i in n)if(n[i]instanceof MCState){const s=n[i];s.local&&!s.traceKey&&(s.traceKey=`lcl_state_${t.key}`,t.states.push(n[i])),n.componentCollection.set(t.key,o),n.componentIdsCollection.set(e,t.key)}return this.mc.componentCollection.set(t.key,o),this.mc.componentIdsCollection.set(e,t.key),o}register(t,e){const n=this.createSignatureComponent(t,e);if(t.states.length)for(const e of t.states)this.mc.isStateLike(e)?(e.virtualCollection.add({effectKey:n.key}),n.states.set(e.id,e.value)):this.mc.log.error("Неверный стейт",["Переданная сигнатура состояния неверна. Проверьте данные которые вы передали в зависимости"]);return this.start(n),n.HTML.instanceMC=n.id,n.HTML.instanceMCtype="mc_component",n.HTML}start(t){this.mc.getCurrentRenderingInstance()?t.HTML=this.mc.engine.rerender(t,"mc_component"):this.mc.engine.controlledRender(t,"mc_component")}}class MCcontext{id;key;virtualCollection;constructor(t){const{id:e,key:n}=t;this.id=e,this.key=n??null,this.virtualCollection=new Set}create(t,e,n){const o={component:t,parent_id:this.id,key:e,identifier:n};return this.virtualCollection.add(o),[{context:this.id,id_element:e},o]}}const _mc_instance_restore_object={instance:null};class MC{original$;mc;stateList;mc_state_global;mc_context_global;fcCollection;fcIdsCollection;componentCollection;componentIdsCollection;componentHandler;currentRenderingInstance;constructor(){this.log=new MCLog(this),this.engine=new MCEngine(this),this.componentHandler=new MC_Component(this),this.stateList=new Map,this.fcCollection=new Map,this.fcIdsCollection=new Map,this.effectCollection=new Map,this.effectIdsCollection=new Map,this.componentCollection=new Map,this.componentIdsCollection=new Map,this.currentRenderingInstance=new Set,this.COUNTER_CLEAR=150,this.checkCountClearedFunctionContainers=this.COUNTER_CLEAR,this.mc_state_global=new Set,this.mc_context_global=new Set,window.$?this.original$=window.$:this.log.error("JQuery функция не была обнаружена!",["Для работы MC данного выпуска необходимо подлючение JQuery версии 1.5 или выше","Проверьте подключение библиотеки, либо используйте init после её определения"])}static init(){if(this.mc)return this.mc.log.warn("На данной странице уже инициализирован Micro Component",["Вы пытаетесь инициализировать MC на странице больше одного раза.","Такое действие не имеет цели для обработчиков МС"]),void this.mc.use();this.mc=new MC,_mc_instance_restore_object.instance=this.mc,window.$.MC=this.mc.use.bind(this),window.$.MC.memo=this.mc.useMemo.bind(this),window.$.MC.effect=this.mc.useEffect.bind(this),window.iMC=this.mc,window.iMC.mc=this;const t=window.$.fn.on;window.$.fn.on=function(e,n,o,i){let s;if("function"==typeof n)s=n;else{if("function"!=typeof i)return t.apply(this,arguments);s=i}const r=this[0];return r&&(r.__mcBound=r.__mcBound||{},r.__mcEvents=r.__mcEvents||{},r.__mcBound[e]||(r.__mcBound[e]=[]),r.__mcEvents[e]||(r.__mcEvents[e]=[]),r.__mcBound[e].push(s),r.__mcEvents[e].push(s)),t.apply(this,arguments)}}static enableFragmentShortSyntax(){if("undefined"==typeof window||!window.$||!window.$.fn||!window.$.fn.init)throw new Error("jQuery не найден в window.$ — нельзя включить fragment short-syntax");if(window.$.mcInitPatched)return;const t=window.$,e=t.fn.init;t.mcOriginalInit||(t.mcOriginalInit=e),t.fn.init=function(t,n,o){if("string"==typeof t&&"</>"===t){const t=e.call(this),n=document.createDocumentFragment();return t[0]=n,t.length=1,t._isDocumentFragment=!0,t}return e.call(this,t,n,o)},t.fn.init.prototype=e.prototype,t.mcInitPatched=!0,t.mcLogPatched||(t.mcLogPatched=!0)}static disableFragmentShortSyntax(){if("undefined"==typeof window||!window.$||!window.$.fn)return;const t=window.$;t.mcInitPatched&&(t.mcOriginalInit&&(t.fn.init=t.mcOriginalInit,t.fn.init.prototype=t.mcOriginalInit.prototype||t.fn,delete t.mcOriginalInit),delete t.mcInitPatched,delete t.mcLogPatched)}static uState(t,e,n){if(!e)return void this.mc.log.error("Ошибка генерации ключа",["Не удалось получить ключ для состояния"]);const[o]=this.mc.getState(e);return o?(n&&o.set(t),o):this.mc.createState(t,e)}static uContext(t){if(!t)return void this.mc.log.error("Ошибка генерации ключа",["Не удалось получить ключ для состояния"]);const e=this.mc.getContext(t);return e||this.mc.createContext(t)}static getState(t){const e=[];return t?(this.mc.mc_state_global.forEach((n=>{n.traceKey===t&&e.push(n)})),e):(this.mc.mc_state_global.forEach((t=>{e.push(t)})),e)}static getContext(t){let e;return this.mc.mc_context_global.forEach((n=>{n.key===t&&(e=n)})),e}setCurrentRenderingInstance(t){this.currentRenderingInstance.add(t)}getCurrentRenderingInstance(){return Array.from(this.currentRenderingInstance).join("_")}resetCurrentRenderingInstance(){this.currentRenderingInstance.clear()}deleteKeyCurrentRenderingInstance(t){this.currentRenderingInstance.delete(t)}state(t){return this.createLocallyState(t,this)}uuidv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)))}getContext(t){let e;return this.mc_context_global.forEach((n=>{n.key===t&&(e=n)})),e}getState(t){const e=[];return t?(this.mc_state_global.forEach((n=>{n.traceKey===t&&e.push(n)})),e):(this.mc_state_global.forEach((t=>{e.push(t)})),e)}getStateID(t){let e=null;return this.mc_state_global.forEach((n=>{n.id===t&&(e=n)})),e}createState(t,e){const n={value:t,traceKey:e,id:this.uuidv4()},o=new MCState(n);return this.engine.registrController(o),this.mc_state_global.add(o),o}createContext(t){const e={id:this.uuidv4(),key:t},n=new MCcontext(e);return this.mc_context_global.add(n),n}createLocallyState(t,e){const n={value:t,id:this.uuidv4(),localKey:null},o=new MCState(n,e);return this.engine.registrController(o),_mc_instance_restore_object.instance.mc_state_global.add(o),o}checkTypeEntity(t){return t.prototype?t.prototype instanceof MC?"mc_component":(this.log.error("Ошибка определения компонента",["Переданные параметры для функции определения не смогли получить сигнатуру компонента","Проверьте правильность создания своих ресурсов"]),"error"):"function"}processFunction(t,e,n,o){if("effect"===o){if(this.getEffectVirtual(t,n))return;return this.createEffect(t,e,n),null}const i=this.getFunctionContainerVirtual(t,n);return i?i.HTML.isConnected?this.workFunctionContainer(i,"memo"===o):(this.removeDeadFunctionContainer(i,e),this.createFunctionContainer(t,e,n)):this.createFunctionContainer(t,e,n)}simpleHash(t){let e=5381;for(let n=0;n<t.length;n++)e=(e<<5)+e+t.charCodeAt(n);return(e>>>0).toString(16)}generateComponentKey(t,e){const n=t.toString().trim();return this.simpleHash(n)+`${e}`}createSignatureFunctionContainer(t,e,n){const o=this.generateComponentKey(t,n),i={draw:t,key:o,id:e,states:new Map,HTML:(new MC_Element).createEmptyElement()};return this.fcCollection.set(o,i),this.fcIdsCollection.set(e,o),i}createFunctionContainer(t,e,n=""){const o=this.uuidv4(),i=this.createSignatureFunctionContainer(t,o,n);if(e&&e.map((t=>{this.isStateLike(t)?(t.fcCollection.add({effectKey:i.key}),i.states.set(t.id,t.value)):this.log.error("Неверный стейт",["Переданная сигнатура состояния неверна. Проверьте данные которые вы передали в зависимости"])})),e&&e.length){const[t]=e;i.states.set(t.id,`reset_state_initial_${this.uuidv4()}`),t.initial()}else this.log.error("Ошибка чтения массива состояний",["Структура функционального контейнера:",`${i.draw}`,"- требует наличия массива зависимостей!","Если вам не нужны зависимости в данном компоненте, скорее всего вы нецелесообразно используете функциональные контейнеры."]);return i.HTML.instanceMC=i.id,i.HTML.instanceMCtype="fn",i.HTML}workFunctionContainer(t,e){return t?e?t.HTML:this.engine.rerender(t):null}getFunctionContainerVirtual(t,e=""){const n=this.generateComponentKey(t,e),o=this.fcCollection.get(n);return o||!1}removeDeadFunctionContainer(t,e){if(this.fcCollection.delete(t.key),this.fcIdsCollection.delete(t.id),e)for(const n of e)for(const e of n.fcCollection)if(e.effectKey===t.key){n.fcCollection.delete(e);break}}removeDeadComponent(t,e){if(this.componentCollection.delete(t.key),this.componentIdsCollection.delete(t.key),e)for(const n of e)for(const e of n.componentCollection)if(e.effectKey===t.key){n.componentCollection.delete(e);break}}async checkAllDeadsFunctionsContainers(){this.checkCountClearedFunctionContainers?--this.checkCountClearedFunctionContainers:(new Promise((()=>{for(const t of this.fcCollection){const[e,n]=t;if(!n.HTML.isConnected){this.fcIdsCollection.delete(n.id);for(const t of n.states){const n=this.getStateID(t[0]);for(const t of n.fcCollection)if(t.effectKey===e){n.fcCollection.delete(t);break}}this.fcCollection.delete(e)}}})),this.checkCountClearedFunctionContainers=this.COUNTER_CLEAR+this.fcCollection.size)}createSignatureEffect(t,e,n){const o=this.generateComponentKey(t,n),i={run:t,key:o,id:e,states:new Map};return this.effectCollection.set(o,i),this.effectIdsCollection.set(e,o),i}createEffect(t,e,n=""){const o=this.uuidv4(),i=this.createSignatureEffect(t,o,n);e&&e.map((t=>{this.isStateLike(t)?(t.effectCollection.add({effectKey:i.key}),i.states.set(t.id,t.value)):this.log.error("Неверный стейт",["Переданная сигнатура состояния неверна. Проверьте данные которые вы передали в зависимости"])})),i.run(i.states.values()),e.length||i.run(i.states.values())}getEffectVirtual(t,e=""){const n=this.generateComponentKey(t,e);return!!this.effectCollection.get(n)}hashString(t){let e=5381;for(let n=0;n<t.length;n++)e=33*e^t.charCodeAt(n);return(e>>>0).toString(36)}serializeForHash(t){if(null==t)return"null";if("string"==typeof t)return`"${t}"`;if("number"==typeof t||"boolean"==typeof t)return String(t);if(Array.isArray(t))return"["+t.map((t=>this.serializeForHash(t))).join(",")+"]";if("object"==typeof t){return"{"+Object.keys(t).sort().map((e=>`"${e}":${this.serializeForHash(t[e])}`)).join(",")+"}"}return String(t)}generateKeyFromNormalized(t){const e=[];return t.component&&e.push(t.component.name||t.component.toString()),t.props&&Object.keys(t.props).length>0&&e.push(this.serializeForHash(t.props)),t.states&&t.states.length>0&&e.push(this.serializeForHash(t.states.map((t=>t.value)))),t.context&&e.push(this.serializeForHash(t.context)),this.hashString(e.join("|"))}isStateLike(t){return!!t&&(t instanceof MCState||"function"==typeof t.get&&"function"==typeof t.set)}normilizeArgs(t){const e={component:null,props:{},states:[],key:void 0,context:null};for(const n of t)if(n&&n.prototype instanceof MC)e.component=n;else if(this.isStateLike(n)){if(n.local){n.incorrectStateBindError=!0,this.log.error("Неправильное назначение",["Локальное состояние компонента не может быть привязано к дочерним компонентам.\n Привязка приведёт к избыточным ререндерингам и потенциальным непредсказуемым побочным эффектам.\n Используйте пропсы или контекстное/глобальное состояние для передачи данных вниз по дереву компонентов.",`traceKey:: ${n.traceKey}`]);continue}e.states.push(n)}else if(Array.isArray(n)&&n.every((t=>this.isStateLike(t)))){let t=!1;if(n.forEach((e=>{e.local&&(t=!0,e.incorrectStateBindError=!0,this.log.error("Неправильное назначение",["Локальное состояние компонента не может быть привязано к дочерним компонентам.\n Привязка приведёт к избыточным ререндерингам и потенциальным непредсказуемым побочным эффектам.\n Используйте пропсы или контекстное/глобальное состояние для передачи данных вниз по дереву компонентов.",`traceKey:: ${e.traceKey}`]))})),t)continue;e.states.push(...n)}else"string"!=typeof n&&"number"!=typeof n?n instanceof MCcontext?e.context=n:null==n||"object"!=typeof n?null!=n&&(e.props=n):e.props=Object.assign({},n):e.key=n;return e}processComponent(t){const e=this.normilizeArgs(t);e.uniquekey=e.key?e.key:this.generateKeyFromNormalized(e),e.key=e.uniquekey;const n=this.uuidv4(),o=this.getCurrentRenderingInstance(),i=o?`${o}_${e.key}`:e.key;if(e.key=i,this.componentCollection.has(e.key)){const t=this.componentCollection.get(e.key);return t.normalized.props=e.props,this.engine.rerender(t,"mc_component")}return this.componentHandler.register(e,n)}use(){const[t,e,n,o]=arguments;switch(this.mc.checkTypeEntity(t)){case"function":return this.mc.processFunction(t,e,n,o);case"mc_component":return this.mc.processComponent(arguments);default:return null}}useMemo(){return 2===arguments.length?this.mc.use.call(this,...arguments,"","memo"):this.mc.use.call(this,...arguments,"memo")}useEffect(){return 2===arguments.length?this.mc.use.call(this,...arguments,"","effect"):this.mc.use.call(this,...arguments,"effect")}}